<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>LifeCycle</h1>
    <button onclick="window.location.href='directory.html'">Directory</button>
    <br>
    <button onclick="saveClientAndLogCall()">Add New Client</button>
    <button id="clearClientsButton">Clear Clients</button>
    <button onclick="window.location.href='referralsdatabase.html'">Referrals Database</button>
    <button id="adminDashboardButton" style="display: none;" onclick="window.location.href='admindashboard.html'">Admin Dashboard</button>    <br><br>
    <button onclick="confirmLogout()">Logout</button>

    <script>
        function confirmLogout() {
            const isConfirmed = confirm('Are you sure you want to log out?');
            if (isConfirmed) {
                // Clear session storage and redirect to the login page
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }
    </script>
        <script>
        document.getElementById('clearClientsButton').addEventListener('click', async function() {
    try {
        const response = await fetch('/clear-clients', {
            method: 'DELETE', // Use DELETE method for clearing clients
            headers: {
                'Content-Type': 'application/json',
            },
        });

        const result = await response.json();
        console.log('Response from server:', result);

        if (result.success) {
            console.log('All clients cleared from the database');
            alert('All clients have been successfully cleared.');
        } else {
            console.error('Failed to clear clients:', result.message);
            alert('Failed to clear clients. Please try again.');
        }
    } catch (error) {
        console.error('Error clearing clients:', error);
        alert('An error occurred while clearing clients. Please try again.');
    }
});

        async function saveClientAndLogCall() {
        const client = {
            id: generateUniqueId(),
            createdAt: new Date(),
        };

        try {
            const response = await fetch('/add-client', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(client),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
                console.log('Client added to the database:', client);
                window.location.href = `call-logging.html?id=${client.id}`;
            } else {
                console.error('Failed to add client:', data.message);
            }
        } catch (error) {
            console.error('Error adding client:', error);
        }
    }

    function populateActiveUser() {
    const activeUser = sessionStorage.getItem('loggedInUser');
    if (activeUser) {
        console.log('Active User:', activeUser); // Debugging

        // Fetch the user's role from the backend
        fetch(`/get-user-role?username=${encodeURIComponent(activeUser)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.role === 'admin') {
                    const csvButton = document.createElement('button');
                    csvButton.textContent = 'Import CSV';
                    csvButton.onclick = () => window.location.href = 'csv-import.html';
                    document.body.appendChild(csvButton);
                } else {
                    console.log('User is not an admin.');
                }
            })
            .catch(error => {
                console.error('Error fetching user role:', error);
            });
    } else {
        console.error('No active user found in sessionStorage');
    }
}

    // Call the function to populate the active user and conditionally add the button
    populateActiveUser();

        function generateUniqueId() {
        const randomSixDigits = Math.floor(100000 + Math.random() * 900000); // Generate a random 6-digit number
        return `ID${randomSixDigits}`;
    }
    </script>

<script>
    function populateActiveUser() {
        const activeUser = sessionStorage.getItem('loggedInUser');
        if (activeUser) {
            console.log('Active User:', activeUser); // Debugging

            // Fetch the user's role from the backend
            fetch(`/get-user-role?username=${encodeURIComponent(activeUser)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Display the cleaned username and role in the upper right-hand corner
                        const userInfoDiv = document.createElement('div');
                        userInfoDiv.style.position = 'fixed';
                        userInfoDiv.style.top = '10px';
                        userInfoDiv.style.right = '10px';
                        userInfoDiv.style.backgroundColor = '#007bff';
                        userInfoDiv.style.color = 'white';
                        userInfoDiv.style.padding = '10px';
                        userInfoDiv.style.borderRadius = '5px';
                        userInfoDiv.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.2)';
                        userInfoDiv.textContent = `User: ${activeUser.trim()} | Role: ${data.role}`;
                        document.body.appendChild(userInfoDiv);

                    }
                })
                .catch(error => {
                    console.error('Error fetching user role:', error);
                });
        } else {
            console.error('No active user found in sessionStorage');
        }
    }

    // Call the function to populate the active user and conditionally add the button
    populateActiveUser();

    function showAdminDashboardButton() {
        const activeUser = sessionStorage.getItem('loggedInUser');
        if (activeUser) {
            fetch(`/get-user-role?username=${encodeURIComponent(activeUser)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.role === 'admin') {
                        document.getElementById('adminDashboardButton').style.display = 'inline-block';
                    } else {
                        console.log('User is not an admin.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching user role:', error);
                });
        } else {
            console.error('No active user found in sessionStorage');
        }
    }

    // Call the function to conditionally show the button
    showAdminDashboardButton();
</script>
</body>
</html>