<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Logging</title>
    <link rel="stylesheet" href="styles.css">
    <script src="userInfo.js"></script>

</head>
<body>
    <h1>Add New Contact</h1>
    <form id="callLogForm">
        <label for="Agent">Contact Center Specialist:</label>
        <input type="text" id="Agent" name="Agent" readonly><br><br>

        <label for="servicingCenter">Service Center:</label>
<select id="servicingCenter" name="servicingCenter" required>
    <option value="" disabled selected>Select Servicing Center</option>
    <option value="PACE Application Center">PACE Application Center</option>
    <option value="Benephilly">Benephilly</option>
    <option value="SNAP Gov">SNAP Gov</option>
</select><br><br>

        <label for="callerFirstName">Contact First Name:</label>
        <input type="text" id="callerFirstName" name="callerFirstName" required><br><br>
        <label for="callerLastName">Contact Last Name:</label>
        <input type="text" id="callerLastName" name="callerLastName" required><br><br>
        <label for="callerPhoneNumber">Contact Phone Number:</label>
        <input type="text" id="callerPhoneNumber" name="callerPhoneNumber" required><br><br>
        <label for="callDirection">Call Direction:</label>
        <select id="callDirection" name="callDirection" required>
            <option value disabled selected>Select Call Direction</option>
            <option value="Inbound">Inbound</option>
            <option value="Outbound">Outbound</option>
        </select><br><br>

        <label for="reasonForCall">Reason for Call:</label>
<select id="reasonForCall" name="reasonForCall">
    <option value="" disabled selected>Select Reason for Call</option>
    <option value="To Apply Myself for Public Benefits">To Apply Myself for Public Benefits</option>
    <option value="To Apply Someone Else for Public Benefits">To Apply Someone Else for Public Benefits</option>
    <option value="To Recertify SNAP and/or Medical Assistance">To Recertify SNAP and/or Medical Assistance </option>
    <option value="Post-Submission Questions">Post-Submission Questions</option>
    <option value="Questions about an Existing Case">Questions about an Existing Case</option>
    <option value="Other">Another Reason</option>
</select><br><br>

        <div id="referralSourceContainer">
            <label for="referralSource">Referral Source:</label>
            <select id="referralSource" name="referralSource" onchange="handleReferralSourceChange()">
                <option value disabled selected>Select Referral Source</option>
                <option value="Outreach">Outreach</option>
                <option value="Referral from a Government Agency">Referral from a Government Agency</option>
                <option value="Referral from a CBO">Referral from a Community-Based Organization</option>
                <option value="Community Referral">Community Referral</option>
                <option value="Internet Search">Internet Search</option>
            </select><br><br>
        </div>

        <div id="specificReferralContainer" style="display: none;">
            <label for="specificReferral">Specifically, which?</label>
            <input type="text" id="specificReferral" name="specificReferral" placeholder="Enter details">
        </div>

        <button type="button" onclick="window.location.href='home.html'"> Home</button>
        <button type="button" onclick="logNewCall()">Log New Call</button>
    </form>
    <script>
        // Function to get query parameter by name
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        async function logNewCall() {
    const requiredFields = ['callerFirstName', 'callerLastName', 'callerPhoneNumber', 'callDirection', 'reasonForCall'];
    for (const field of requiredFields) {
        const fieldElement = document.getElementById(field);

        // Skip hidden fields
        if (fieldElement && fieldElement.classList.contains('hidden')) {
            console.log(`Skipping hidden field: ${field}`);
            continue;
        }

        // Skip reasonForCall if callDirection is Outbound
        if (field === 'reasonForCall' && document.getElementById('callDirection').value === 'Outbound') {
            console.log('Skipping reasonForCall because callDirection is Outbound');
            continue;
        }

        console.log(`Checking field: ${field}, Value: ${fieldElement ? fieldElement.value : 'Field not found'}`);
        if (!fieldElement || !fieldElement.value) {
            alert('Please fill out all required fields.');
            return;
        }
    }

    const referralSourceContainer = document.getElementById('referralSourceContainer');
    if (referralSourceContainer.style.display !== 'none' && !document.getElementById('referralSource').value) {
        alert('Please fill out all required fields.');
        return;
    }

    const specificReferralContainer = document.getElementById('specificReferralContainer');
    const specificReferral = specificReferralContainer.style.display !== 'none'
        ? document.getElementById('specificReferral').value
        : null;

    const clientId = getQueryParam('id');
    const callLog = {
        agent: document.getElementById('Agent').value,
        servicingCenter: document.getElementById('servicingCenter').value,
        callerFirstName: document.getElementById('callerFirstName').value,
        callerLastName: document.getElementById('callerLastName').value,
        callerPhoneNumber: document.getElementById('callerPhoneNumber').value,
        callDirection: document.getElementById('callDirection').value,
        reasonForCall: document.getElementById('reasonForCall').value,
        referralSource: document.getElementById('referralSource').value,
        specificReferral: specificReferral, // Save the "Specifically, which?" field
        timestamp: new Date().toLocaleString(),
    };

    try {
// Save caller details if reasonForCall is not "None"
if (callLog.reasonForCall !== "None") {
    const clientData = {
        firstName: callLog.callerFirstName,
        lastName: callLog.callerLastName,
        phoneNumber: callLog.callerPhoneNumber,
    };

    // Save to Contacts only if reasonForCall is "To Apply Someone Else for Public Benefits"
    if (callLog.reasonForCall === "To Apply Someone Else for Public Benefits") {
        const addToContactsResponse = await fetch('/add-to-contacts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                clientId,
                contact: clientData,
            }),
        });

        const addToContactsResult = await addToContactsResponse.json();
        if (!addToContactsResponse.ok || !addToContactsResult.success) {
            alert(addToContactsResult.message || 'Failed to save contact details.');
            return;
        }
    } else {
        // Save caller details to the client
        const updateClientResponse = await fetch('/update-client', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ clientId, clientData }),
        });

        const updateClientResult = await updateClientResponse.json();
        if (!updateClientResponse.ok || !updateClientResult.success) {
            alert(updateClientResult.message || 'Failed to update client details.');
            return;
        }

        // Add caller details to the Contacts array
        const addToContactsResponse = await fetch('/add-to-contacts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                clientId,
                contact: clientData,
            }),
        });

        const addToContactsResult = await addToContactsResponse.json();
        if (!addToContactsResponse.ok || !addToContactsResult.success) {
            alert(addToContactsResult.message || 'Failed to save contact details.');
            return;
        }
    }
}

        // Log the call
        const logCallResponse = await fetch('/log-call', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ clientId, callLog }),
        });

        const logCallResult = await logCallResponse.json();
        if (logCallResponse.ok && logCallResult.success) {
            // Create a note for profile creation
            const activeUser = sessionStorage.getItem('loggedInUser');
            const profileCreationNote = {
                text: `Profile created.`,
                timestamp: callLog.timestamp,
                username: activeUser,
            };

            // Add the profile creation note to the database
            const addProfileNoteResponse = await fetch('/add-note-to-client', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ clientId, note: profileCreationNote }),
            });

            const addProfileNoteResult = await addProfileNoteResponse.json();
            if (!addProfileNoteResponse.ok || !addProfileNoteResult.success) {
                alert('Failed to add profile creation note.');
                return;
            }

            // Create a note for the call
            const callNote = {
                text: `<strong>${callLog.callDirection} call logged.</strong> <br><br> Service Center: <br><br> ${callLog.servicingCenter}.`,
                timestamp: callLog.timestamp,
                username: activeUser,
            };

            // Add the call note to the database
            const addCallNoteResponse = await fetch('/add-note-to-client', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ clientId, note: callNote }),
            });

            const addCallNoteResult = await addCallNoteResponse.json();
            if (!addCallNoteResponse.ok || !addCallNoteResult.success) {
                alert('Failed to add note to client.');
                return;
            }

            // Add the notes to the notes container in the UI
            const notesContainer = document.getElementById('notesContainer');
            if (notesContainer) {
                const profileNoteElement = document.createElement('div');
                profileNoteElement.classList.add('note');
                profileNoteElement.innerHTML = `
                    <p><strong>${profileCreationNote.timestamp}</strong></p>
                    <p>${profileCreationNote.text}</p>
                    <p><em>Logged by: ${profileCreationNote.username}</em></p>
                `;
                notesContainer.appendChild(profileNoteElement);

                const callNoteElement = document.createElement('div');
                callNoteElement.classList.add('note');
                callNoteElement.innerHTML = `
                    <p><strong>${callNote.timestamp}</strong></p>
                    <p>${callNote.text}</p>
                    <p><em>Logged by: ${callNote.username}</em></p>
                `;
                notesContainer.appendChild(callNoteElement);
            }

            // Redirect based on the reason for the call
            if (callLog.reasonForCall === "To Apply Myself for Public Benefits" || 
                callLog.reasonForCall === "To Apply Someone Else for Public Benefits" ||
                callLog.reasonForCall === "To Recertify SNAP and/or Medical Assistance" || 
                callLog.reasonForCall === "CAP Outreach" || 
                callLog.reasonForCall === "Questions about an Existing Case" || 
                callLog.reasonForCall === "Post-Submission Questions" || 
                callLog.reasonForCall === "Other") {
                const url = `profileedit.html?id=${clientId}`;
                window.location.href = url;
            } else {
                window.location.href = `profileedit.html?id=${clientId}`;
            }
        } else {
            alert(logCallResult.message || 'Failed to log call.');
        }
    } catch (error) {
        console.error('Error logging call:', error);
    }
}

        function populateActiveUser() {
            const activeUser = sessionStorage.getItem('loggedInUser');
            if (activeUser) {
                document.getElementById('Agent').value = activeUser;
            }
        }

        function toggleReferralSource() {
            const callDirection = document.getElementById('callDirection').value;
            const referralSourceContainer = document.getElementById('referralSourceContainer');
            if (callDirection === 'Outbound') {
                referralSourceContainer.style.display = 'none';
                document.getElementById('referralSource').removeAttribute('required');
            } else {
                referralSourceContainer.style.display = 'block';
                document.getElementById('referralSource').setAttribute('required', 'required');
            }
        }

        function handleReferralSourceChange() {
    const referralSource = document.getElementById('referralSource').value;
    const specificReferralContainer = document.getElementById('specificReferralContainer');

    if (
        referralSource === 'Referral from a Government Agency' ||
        referralSource === 'Referral from a CBO' ||
        referralSource === 'Community Referral'
    ) {
        specificReferralContainer.style.display = 'block';
        document.getElementById('specificReferral').setAttribute('required', 'required');
    } else {
        specificReferralContainer.style.display = 'none';
        document.getElementById('specificReferral').removeAttribute('required');
    }
}

function toggleReasonForCall() {
    const callDirection = document.getElementById('callDirection').value;
    const reasonForCallLabel = document.querySelector('label[for="reasonForCall"]');
    const reasonForCallSelect = document.getElementById('reasonForCall');
    const referralSourceContainer = document.getElementById('referralSourceContainer');

     // Also toggle referral source based on call direction

    if (callDirection === 'Outbound') {
        reasonForCallLabel.style.display = 'none';
        reasonForCallSelect.style.display = 'none';
        reasonForCallSelect.removeAttribute('required');
        referralSourceContainer.style.display = 'none';
        document.getElementById('referralSource').removeAttribute('required');
    } else {
        reasonForCallLabel.style.display = 'inline-block';
        reasonForCallSelect.style.display = 'inline-block';
        reasonForCallSelect.setAttribute('required', 'required');
        referralSourceContainer.style.display = 'block';
        document.getElementById('referralSource').setAttribute('required', 'required');
    }
}
document.getElementById('callDirection').addEventListener('change', toggleReasonForCall);

        window.onload = function() {
            populateActiveUser();
            toggleReasonForCall(); // Ensure the correct state on page load
        };
    </script>
</body>
</html>