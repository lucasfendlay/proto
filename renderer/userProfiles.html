<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profiles</title>
    <link rel="stylesheet" href="styles.css">
</head>

<style>

#profileLinks li {
    list-style-type: none; /* Remove bullet points */
}
    /* Shared container width */
    .container {
        width: 100%; /* Full width */
        max-width: 1500px; /* Optional: Limit the maximum width */
        margin: 0 auto; /* Center the container horizontally */
        display: flex; /* Enable flexbox */
        flex-direction: column; /* Stack children vertically */
        align-items: center; /* Center children horizontally */
    }

    /* Input fields */
    input[type="text"] {
        width: 100%; /* Full width within the container */
        max-width: 1500px; /* Optional: Limit the maximum width */
        box-sizing: border-box; /* Include padding and border in the width */
        margin-bottom: 10px; /* Add spacing between inputs */
        align-self: center; /* Center the input fields */
        padding: 10px; /* Add padding for better usability */
        border: 1px solid #ccc; /* Light gray border */
        border-radius: 4px; /* Slightly rounded corners */
        font-size: 16px; /* Increase font size for better readability */
    }

    /* Profile list container */
    #profileLinks {
        width: 100%; /* Full width within the container */
        max-width: 1500px; /* Optional: Limit the maximum width */
        padding: 0; /* Remove default padding */
        display: flex; /* Enable flexbox for the list */
        flex-direction: column; /* Stack list items vertically */
        align-items: center; /* Center list items horizontally */
        text-transform: uppercase; /* Force all text to display in uppercase */
    }

    /* List items */
    #profileLinks a {
        width: 100%; /* Full width of the container */
        max-width: 1500px; /* Optional: Limit the maximum width */
        text-align: center; /* Center the text */
        padding: 10px; /* Add padding for readability */
        border-bottom: 1px solid #ccc; /* Optional: Add a border for separation */
        list-style: none; /* Remove default bullet points */
        color: #000dff; /* Set link color to blue */
        display: block; /* Make the link take up the full width of the list item */
    }

    #profileLinks a:hover {
        background-color: #f0f0f0; /* Optional: Add a hover effect */
    }
</style>

<body>
    <h1>User Profiles</h1>
    <button onclick="window.location.href='admindashboard.html'">Back to Dashboard</button>
    <br><br>
    <!-- Add a dynamic header -->
    <h2 id="dynamicHeader"></h2>
    <div class="container">
        <div id="profileLinks">
            <!-- Dynamically populated profile links will go here -->
        </div>
    </div>

    <script>
function formatMetricName(metric) {
    const metricMapping = {
        screeningsStarted: 'Screenings Initiated',
        ptrrApplicationsCompleted: 'PTRR Applications Completed',
        // Add more mappings as needed
    };
    return metricMapping[metric] || metric; // Default to the original name if no mapping exists
}

function formatDate(dateString) {
    if (!dateString) return null;
    const date = new Date(dateString);
    return new Intl.DateTimeFormat('en-US', { month: 'long', day: 'numeric', year: 'numeric' }).format(date);
}

async function populateProfiles() {
    const params = new URLSearchParams(window.location.search);
    const metric = params.get('metric');
    const user = params.get('user');
    const startDate = formatDate(params.get('startDate'));
    const endDate = formatDate(params.get('endDate'));

    // Format the metric name
    const formattedMetric = formatMetricName(metric);

    // Set the dynamic header
    const dynamicHeader = document.getElementById('dynamicHeader');
    dynamicHeader.textContent = `All ${formattedMetric || 'Metrics'} for ${user || 'Users'} between ${startDate || 'Start Date'} and ${endDate || 'End Date'}`;

    console.log('Metric:', metric);
    console.log('User:', user);
    console.log('Start Date:', startDate);
    console.log('End Date:', endDate);

    try {
        const response = await fetch(`/get-user-profiles?metric=${metric}&user=${user}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const profiles = await response.json();
        console.log('Fetched Profiles:', profiles);

        // Filter profiles to remove duplicates
        const uniqueProfiles = [];
        const seenIds = new Set();

        profiles.forEach(profile => {
            if (!seenIds.has(profile.id)) {
                uniqueProfiles.push(profile);
                seenIds.add(profile.id);
            }
        });

        const profileLinksDiv = document.getElementById('profileLinks');
        if (uniqueProfiles.length === 0) {
            profileLinksDiv.innerHTML = `<li>No profiles found for the specified filters.</li>`;
            return;
        }

        profileLinksDiv.innerHTML = ``;
        uniqueProfiles.forEach(profile => {
            const mostRecentNote = profile.notes?.[profile.notes.length - 1];
            const mostRecentActivity = mostRecentNote ? (mostRecentNote.timestamp) : 'No recent activity';

            const li = document.createElement('li');
            li.innerHTML = `
                <a href="profileview.html?id=${profile.id}">
                    <strong>Profile: ${profile.id}</strong> | 
                    ${profile.name || ''} | 
                    ${profile.phoneNumber ? `Phone: ${profile.phoneNumber} | ` : ''}
                    ${profile.streetAddress || profile.city || profile.state || profile.zipCode ? `Address: ${[
                        profile.streetAddress,
                        profile.city,
                        profile.state,
                        profile.zipCode,
                        profile.county ? `${profile.county} County` : ''
                    ].filter(Boolean).join(', ')} | ` : ''}
                    <strong>Most Recent Activity:</strong> ${mostRecentActivity}
                </a>`;
            profileLinksDiv.appendChild(li);
        });
    } catch (error) {
        console.error('Error fetching profiles:', error);
    }
}
document.addEventListener('DOMContentLoaded', populateProfiles);

    </script>
</body>

</html>