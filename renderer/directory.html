<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Clients</title>
    <link rel="stylesheet" href="styles.css">
</head>

<style>
     /* Shared container width */
     .container {
        width: 100%; /* Full width */
        max-width: 1500px; /* Optional: Limit the maximum width */
        margin: 0 auto; /* Center the container horizontally */
        display: flex; /* Enable flexbox */
        flex-direction: column; /* Stack children vertically */
        align-items: center; /* Center children horizontally */
    }

    /* Input fields */
    input[type="text"] {
        width: 100%; /* Full width within the container */
        max-width: 1500px; /* Optional: Limit the maximum width */
        box-sizing: border-box; /* Include padding and border in the width */
        margin-bottom: 10px; /* Add spacing between inputs */
        align-self: center; /* Center the input fields */
        padding: 10px; /* Add padding for better usability */
        border: 1px solid #ccc; /* Light gray border */
        border-radius: 4px; /* Slightly rounded corners */
        font-size: 16px; /* Increase font size for better readability */
    }

    /* Client list container */
    #clientList {
        width: 100%; /* Full width within the container */
        max-width: 1500px; /* Optional: Limit the maximum width */
        padding: 0; /* Remove default padding */
        display: flex; /* Enable flexbox for the list */
        flex-direction: column; /* Stack list items vertically */
        align-items: center; /* Center list items horizontally */
        text-transform: uppercase; /* Force all text to display in uppercase */

    }

    /* List items */
    #clientList li {
        width: 100%; /* Full width of the container */
        max-width: 1500px; /* Optional: Limit the maximum width */
        text-align: center; /* Center the text */
        padding: 10px; /* Add padding for readability */
        border-bottom: 1px solid #ccc; /* Optional: Add a border for separation */
        list-style: none; /* Remove default bullet points */
    }

    /* Links inside list items */
    #clientList li a {
        color: #000dff; /* Set link color to black */
        display: block; /* Make the link take up the full width of the list item */
    }

    #clientList li a:hover {
        background-color: #f0f0f0; /* Optional: Add a hover effect */
    }
</style>

<body>
    <h1>Search Clients</h1>
    <button onclick="window.location.href='home.html'">Home</button>
    <br>
    <button onclick="saveClientAndLogCall()">Add New Client</button>
    <br><br>
    <div class="container">
        <input type="text" id="searchId" oninput="searchClients()" placeholder="Search by Profile ID...">
        <input type="text" id="searchFirstName" oninput="searchClients()" placeholder="Search by First Name...">
        <input type="text" id="searchLastName" oninput="searchClients()" placeholder="Search by Last Name...">
        <input type="text" id="searchPhoneNumber" oninput="searchClients()" placeholder="Search by Phone Number...">
        <input type="text" id="searchStreetAddress" oninput="searchClients()" placeholder="Search by Street Address...">
        <input type="text" id="searchCity" oninput="searchClients()" placeholder="Search by City...">
        <input type="text" id="searchCounty" oninput="searchClients()" placeholder="Search by County...">
        <ul id="clientList"></ul>
    </div>

    <!-- Add Fuse.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>

    <script>
        async function fetchClients() {
        try {
            const response = await fetch('/get-all-clients');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data.clients || [];
        } catch (error) {
            console.error('Error fetching clients:', error);
            return [];
        }
    }

    async function searchClients() {
        const searchInputs = {
            id: document.getElementById('searchId').value.trim(),
            firstName: document.getElementById('searchFirstName').value.trim(),
            lastName: document.getElementById('searchLastName').value.trim(),
            phoneNumber: document.getElementById('searchPhoneNumber').value.trim(),
            streetAddress: document.getElementById('searchStreetAddress').value.trim(),
            city: document.getElementById('searchCity').value.trim(),
            county: document.getElementById('searchCounty').value.trim(),
        };

        // Check if all search fields are empty
        const allFieldsEmpty = Object.values(searchInputs).every(value => value === '');
        if (allFieldsEmpty) {
            await loadClients(); // Repopulate the client list with all clients
            return;
        }

        const clients = await fetchClients();

        // Prepare Fuse.js options
        const fuseOptions = {
            includeScore: true,
            threshold: 0.4, // Adjust for fuzziness tolerance
        };

        // Perform field-specific searches
        const fieldResults = {};
        for (const [field, query] of Object.entries(searchInputs)) {
            if (query) {
                const fuse = new Fuse(clients, { ...fuseOptions, keys: [field] });
                fieldResults[field] = fuse.search(query);
            }
        }

        // Aggregate scores for each client
        const clientScores = {};
        for (const [field, results] of Object.entries(fieldResults)) {
            results.forEach(({ item, score }) => {
                if (!clientScores[item.id]) {
                    clientScores[item.id] = { client: item, totalScore: 0 };
                }
                clientScores[item.id].totalScore += (1 - score); // Higher score = more relevant
            });
        }

        // Convert aggregated scores to a sorted array
        const sortedResults = Object.values(clientScores).sort((a, b) => {
            if (b.totalScore === a.totalScore) {
                // Sort by most recent note timestamp if scores are equal
                const aLastNote = a.client.notes?.[a.client.notes.length - 1]?.timestamp || 0;
                const bLastNote = b.client.notes?.[b.client.notes.length - 1]?.timestamp || 0;
                return new Date(bLastNote) - new Date(aLastNote);
            }
            return b.totalScore - a.totalScore; // Higher total score first
        });

        // Render the results
        const clientList = document.getElementById('clientList');
        clientList.innerHTML = '';

        if (sortedResults.length === 0) {
            const noResultsMessage = document.createElement('li');
            noResultsMessage.textContent = 'No clients found.';
            clientList.appendChild(noResultsMessage);
        } else {
            sortedResults.forEach(({ client }) => {
                if (!client.firstName || !client.lastName || !client.phoneNumber) {
                    return;
                }

                // Get the most recent note timestamp
                const mostRecentNote = client.notes?.[client.notes.length - 1];
                const mostRecentActivity = mostRecentNote ? mostRecentNote.timestamp : '<strong>No recent activity</strong>';

                const li = document.createElement('li');
                li.innerHTML = `
                    <a href="profileview.html?id=${client.id}">
                        <strong>Profile: ${client.id}</strong> | 
                        ${client.firstName || ''} ${client.lastName || ''} | 
                        ${client.phoneNumber ? `Phone: ${client.phoneNumber} | ` : ''}
                        ${client.streetAddress || client.city || client.state || client.zipCode ? `Address: ${[
                            client.streetAddress,
                            client.city,
                            client.state,
                            client.zipCode,
                            client.county ? `${client.county} County` : ''
                        ].filter(Boolean).join(', ')} | ` : ''}
                        <strong>Most Recent Activity:</strong> ${mostRecentActivity}
                    </a>`;
                clientList.appendChild(li);
            });
        }
    }

    async function loadClients() {
        const clients = await fetchClients();

        // Sort clients by the most recent note timestamp
        clients.sort((a, b) => {
            const aLastNote = a.notes?.[a.notes.length - 1]?.timestamp || 0;
            const bLastNote = b.notes?.[b.notes.length - 1]?.timestamp || 0;
            return new Date(bLastNote) - new Date(aLastNote);
        });

        const clientList = document.getElementById('clientList');
        clientList.innerHTML = '';

        if (clients.length === 0) {
            const noResultsMessage = document.createElement('li');
            noResultsMessage.textContent = 'No clients found.';
            clientList.appendChild(noResultsMessage);
        } else {
            clients.forEach((client) => {
                if (!client.firstName || !client.lastName) {
                    return;
                }

                // Get the most recent note timestamp
            const mostRecentNote = client.notes?.[client.notes.length - 1];
            const mostRecentActivity = mostRecentNote ? mostRecentNote.timestamp : 'No recent activity';

            const li = document.createElement('li');
            li.innerHTML = `
    <a href="profileview.html?id=${client.id}">
        <strong>Profile: ${client.id} </strong> | 
        ${client.firstName || ''} ${client.lastName || ''} | 
        ${client.phoneNumber ? `Phone: ${client.phoneNumber} | ` : ''}
        ${client.streetAddress || client.city || client.state || client.zipCode ? `Address: ${[
            client.streetAddress,
            client.city,
            client.state,
            client.zipCode,
            client.county ? `${client.county} County` : ''
        ].filter(Boolean).join(', ')} | ` : ''}
        <strong>Most Recent Activity:</strong> ${mostRecentActivity}
    </a>`;
            clientList.appendChild(li);
        });
    }
    }

        async function saveClientAndLogCall() {
            const client = {
                id: generateUniqueId(),
                createdAt: new Date(),
            };

            try {
                const response = await fetch('/add-client', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(client),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    console.log('Client added to the database:', client);
                    window.location.href = `call-logging.html?id=${client.id}`;
                } else {
                    console.error('Failed to add client:', data.message);
                }
            } catch (error) {
                console.error('Error adding client:', error);
            }
        }

        function generateUniqueId() {
            const randomSixDigits = Math.floor(100000 + Math.random() * 900000); // Generate a random 6-digit number
            return `ID${randomSixDigits}`;
        }

        // Load all clients on page load
        window.onload = loadClients;
    </script>

<script>
    function populateActiveUser() {
        const activeUser = sessionStorage.getItem('loggedInUser');
        if (activeUser) {
            console.log('Active User:', activeUser); // Debugging

            // Fetch the user's role from the backend
            fetch(`/get-user-role?username=${encodeURIComponent(activeUser)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Display the cleaned username and role in the upper right-hand corner
                        const userInfoDiv = document.createElement('div');
                        userInfoDiv.style.position = 'fixed';
                        userInfoDiv.style.top = '10px';
                        userInfoDiv.style.right = '10px';
                        userInfoDiv.style.backgroundColor = '#007bff';
                        userInfoDiv.style.color = 'white';
                        userInfoDiv.style.padding = '10px';
                        userInfoDiv.style.borderRadius = '5px';
                        userInfoDiv.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.2)';
                        userInfoDiv.textContent = `User: ${activeUser.trim()} | Role: ${data.role}`;
                        document.body.appendChild(userInfoDiv);

                    }
                })
                .catch(error => {
                    console.error('Error fetching user role:', error);
                });
        } else {
            console.error('No active user found in sessionStorage');
        }
    }

    // Call the function to populate the active user and conditionally add the button
    populateActiveUser();
</script>

</body>
</html>