<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Clients</title>
    <link rel="stylesheet" href="styles.css">
</head>

<style>
     /* Shared container width */
     .container {
        width: 100%; /* Full width */
        max-width: 1500px; /* Optional: Limit the maximum width */
        margin: 0 auto; /* Center the container horizontally */
        display: flex; /* Enable flexbox */
        flex-direction: column; /* Stack children vertically */
        align-items: center; /* Center children horizontally */
    }

    /* Input fields */
    input[type="text"] {
        width: 100%; /* Full width within the container */
        max-width: 1500px; /* Optional: Limit the maximum width */
        box-sizing: border-box; /* Include padding and border in the width */
        margin-bottom: 10px; /* Add spacing between inputs */
        align-self: center; /* Center the input fields */
        padding: 10px; /* Add padding for better usability */
        border: 1px solid #ccc; /* Light gray border */
        border-radius: 4px; /* Slightly rounded corners */
        font-size: 16px; /* Increase font size for better readability */
    }

    /* Client list container */
    #clientList {
        width: 100%; /* Full width within the container */
        max-width: 1500px; /* Optional: Limit the maximum width */
        padding: 0; /* Remove default padding */
        display: flex; /* Enable flexbox for the list */
        flex-direction: column; /* Stack list items vertically */
        align-items: center; /* Center list items horizontally */
        text-transform: uppercase; /* Force all text to display in uppercase */

    }

    /* List items */
    #clientList li {
        width: 100%; /* Full width of the container */
        max-width: 1500px; /* Optional: Limit the maximum width */
        text-align: center; /* Center the text */
        padding: 10px; /* Add padding for readability */
        border-bottom: 1px solid #ccc; /* Optional: Add a border for separation */
        list-style: none; /* Remove default bullet points */
    }

    /* Links inside list items */
    #clientList li a {
        color: #000dff; /* Set link color to black */
        display: block; /* Make the link take up the full width of the list item */
    }

    #clientList li a:hover {
        background-color: #f0f0f0; /* Optional: Add a hover effect */
    }
</style>

<body>
    <h1>Search Clients</h1>
    <button onclick="window.location.href='home.html'">Home</button>
    <br>
    <button onclick="saveClientAndLogCall()">Add New Client</button>
    <br><br>
    <div class="container">
        <input type="text" id="searchId" oninput="searchClients()" placeholder="Search by Profile ID...">
        <input type="text" id="searchFirstName" oninput="searchClients()" placeholder="Search by First Name...">
        <input type="text" id="searchLastName" oninput="searchClients()" placeholder="Search by Last Name...">
        <input type="text" id="searchPhoneNumber" oninput="searchClients()" placeholder="Search by Phone Number...">
        <input type="text" id="searchStreetAddress" oninput="searchClients()" placeholder="Search by Street Address...">
        <input type="text" id="searchCity" oninput="searchClients()" placeholder="Search by City...">
        <input type="text" id="searchCounty" oninput="searchClients()" placeholder="Search by County...">
        <ul id="clientList"></ul>
    </div>

    <!-- Add Fuse.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>

    <script>
        async function fetchClients() {
        try {
            const response = await fetch('/get-all-clients');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data.clients || [];
        } catch (error) {
            console.error('Error fetching clients:', error);
            return [];
        }
    }

    async function searchClients() {
    const searchInputs = {
        id: document.getElementById('searchId').value.toLowerCase(),
        firstName: document.getElementById('searchFirstName').value.toLowerCase(),
        lastName: document.getElementById('searchLastName').value.toLowerCase(),
        phoneNumber: document.getElementById('searchPhoneNumber').value.toLowerCase(),
        streetAddress: document.getElementById('searchStreetAddress').value.toLowerCase(),
        city: document.getElementById('searchCity').value.toLowerCase(),
        county: document.getElementById('searchCounty').value.toLowerCase(),
    };

    const clients = await fetchClients();

// Fuse.js configuration
const options = {
    keys: [
        {
            name: 'id',
            weight: 1,
            getFn: (client) => client.id.replace(/^id/i, ''), // Remove "id" prefix (case-insensitive)
        },
        { name: 'firstName', weight: 1 },
        { name: 'lastName', weight: 1 },
        { name: 'phoneNumber', weight: 1 },
        { name: 'streetAddress', weight: 1 },
        { name: 'city', weight: 1 },
        { name: 'county', weight: 1 },
    ],
    threshold: 0.4, // Adjust threshold for sensitivity
    includeScore: true,
    distance: 100,
    ignoreLocation: true, // Ignore location to focus on content match
};
    const fuse = new Fuse(clients, options);

    // Filter clients using Fuse.js for fuzzy matching
    let results = clients;

    Object.keys(searchInputs).forEach(key => {
        if (searchInputs[key]) {
            const filteredResults = fuse.search(searchInputs[key]).map(result => result.item);
            results = results.filter(client => filteredResults.includes(client));
        }
    });

    // Sort results by relevance score (closest match) first, then by most recent note timestamp
    results = results.map(client => ({ item: client, score: 0 })); // Reset scores for sorting
    results.sort((a, b) => {
        if (a.score !== b.score) {
            return a.score - b.score; // Lower score means closer match
        }
        const aLastNote = a.item.notes?.[a.item.notes.length - 1]?.timestamp || 0;
        const bLastNote = b.item.notes?.[b.item.notes.length - 1]?.timestamp || 0;
        return new Date(bLastNote) - new Date(aLastNote); // Most recent note first
    });

    const clientList = document.getElementById('clientList');
    clientList.innerHTML = '';

    if (results.length === 0) {
        const noResultsMessage = document.createElement('li');
        noResultsMessage.textContent = 'No clients found.';
        clientList.appendChild(noResultsMessage);
    } else {
        results.forEach(({ item: client }) => {
            if (!client.firstName || !client.lastName || !client.phoneNumber) {
                return;
            }

            // Get the most recent note timestamp
            const mostRecentNote = client.notes?.[client.notes.length - 1];
            const mostRecentActivity = mostRecentNote ? mostRecentNote.timestamp : 'No recent activity';

            const li = document.createElement('li');
            li.innerHTML = `
                <a href="profileview.html?id=${client.id}">
                    <strong>Profile: ${client.id}</strong> | 
                    ${client.firstName || ''} ${client.lastName || ''} | 
                    ${client.phoneNumber ? `Phone: ${client.phoneNumber} | ` : ''}
                    ${client.streetAddress || client.city || client.state || client.zipCode ? `Address: ${[
                        client.streetAddress,
                        client.city,
                        client.state,
                        client.zipCode,
                        client.county ? `${client.county} County` : ''
                    ].filter(Boolean).join(', ')} | ` : ''}
                    <strong>Most Recent Activity:</strong> ${mostRecentActivity}
                </a>`;
            clientList.appendChild(li);
        });
    }
}

    async function loadClients() {
        const clients = await fetchClients();

        // Sort clients by the most recent note timestamp
        clients.sort((a, b) => {
            const aLastNote = a.notes?.[a.notes.length - 1]?.timestamp || 0;
            const bLastNote = b.notes?.[b.notes.length - 1]?.timestamp || 0;
            return new Date(bLastNote) - new Date(aLastNote);
        });

        const clientList = document.getElementById('clientList');
        clientList.innerHTML = '';

        if (clients.length === 0) {
            const noResultsMessage = document.createElement('li');
            noResultsMessage.textContent = 'No clients found.';
            clientList.appendChild(noResultsMessage);
        } else {
            clients.forEach((client) => {
                if (!client.firstName || !client.lastName || !client.phoneNumber) {
                    return;
                }

                // Get the most recent note timestamp
            const mostRecentNote = client.notes?.[client.notes.length - 1];
            const mostRecentActivity = mostRecentNote ? mostRecentNote.timestamp : 'No recent activity';

            const li = document.createElement('li');
            li.innerHTML = `
    <a href="profileview.html?id=${client.id}">
        <strong>Profile: ${client.id} </strong> | 
        ${client.firstName || ''} ${client.lastName || ''} | 
        ${client.phoneNumber ? `Phone: ${client.phoneNumber} | ` : ''}
        ${client.streetAddress || client.city || client.state || client.zipCode ? `Address: ${[
            client.streetAddress,
            client.city,
            client.state,
            client.zipCode,
            client.county ? `${client.county} County` : ''
        ].filter(Boolean).join(', ')} | ` : ''}
        <strong>Most Recent Activity:</strong> ${mostRecentActivity}
    </a>`;
            clientList.appendChild(li);
        });
    }
    }

        async function saveClientAndLogCall() {
            const client = {
                id: generateUniqueId(),
                createdAt: new Date(),
            };

            try {
                const response = await fetch('/add-client', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(client),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    console.log('Client added to the database:', client);
                    window.location.href = `call-logging.html?id=${client.id}`;
                } else {
                    console.error('Failed to add client:', data.message);
                }
            } catch (error) {
                console.error('Error adding client:', error);
            }
        }

        function generateUniqueId() {
            const randomSixDigits = Math.floor(100000 + Math.random() * 900000); // Generate a random 6-digit number
            return `ID${randomSixDigits}`;
        }

        // Load all clients on page load
        window.onload = loadClients;
    </script>
</body>
</html>