<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Applicant</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="householdedit.css">
    <link rel="stylesheet" href="notes.css">
    <script src="userInfo.js"></script>

    <style>
    
    select[readonly] {
    pointer-events: none;
    background-color: #e9ecef; /* Optional: Gray background to indicate it's readonly */
}

    /* Button container styling */
        .button-container {
    display: flex;
    justify-content: center; /* Center the button horizontally */
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 20px;
}

.button-container button {
flex: 1;
padding: 10px 15px !important; /* Override global padding */
font-size: 1rem;
cursor: pointer;
border: none; /* Remove global border */
margin: 0; /* Remove global margin */
}

/* Selection box styling */
.selection-box div.selected {
    background-color: #007bff;
    color: white;
    border: 1px solid #0056b3;
    border-radius: 5px;
    padding: 5px;
}

/* Sidebar header styling */
.sidebar-header {
    display: fixed;
    justify-items: center; /* Center content horizontally */
    text-align: center; /* Center text */
    margin-bottom: 20px; /* Add spacing below the header */
    width: 300px; /* Match the width of .left-sidebar */
    margin: 0 auto; /* Center the header horizontally */
}

.sidebar-header .button-container {
    display: flex;
    justify-content: center; /* Center the button horizontally */
    width: 100%; /* Ensure the button container spans the full width */
}

/* Contacts list container */
#contacts-list {
    display: flex;
    flex-direction: column;
    gap: 15px; /* Adds spacing between items */
    width: 300px; /* Match the width of .left-sidebar */
    margin: 0 auto; /* Center the header horizontally */
    max-height: 1000px; /* Match the height of householdedit containers */
    overflow-y: auto; /* Add scroll if content overflows */
    background-color: #f4f4f4; /* Light gray background */
    border: 1px solid #ddd; /* Border around the container */
    border-radius: 8px; /* Rounded corners */
    padding: 15px; /* Padding inside the container */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
}

/* Individual sidebar items */
.left-sidebar {
    background-color: #fff; /* White background for each item */
    border: 1px solid #ccc; /* Border around each item */
    border-radius: 5px; /* Rounded corners for each item */
    padding: 10px; /* Padding inside each item */
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* Subtle shadow for each item */
    margin: 0 auto; /* Center the sidebar items horizontally */
    width: 280px; /* Adjust width as needed */
    transform: translateX(-8px); /* Shift the sidebar 10px to the left */

}


.left-sidebar strong {
    font-weight: bold; /* Bold labels */
}

        /* Modal styling */
        .contactmodal {
display: none;
position: fixed; /* Position relative to the viewport */
top: 0;
left: 0;
width: 100vw; /* Full viewport width */
height: 100vh; /* Full viewport height */
background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
z-index: 1000; /* Ensure it appears above other elements */
display: flex; /* Use flexbox for centering */
justify-content: center; /* Center horizontally */
align-items: center; /* Center vertically */
overflow: hidden; /* Prevent scrolling */
}

.contactmodal-content {
background-color: transparent;
border-radius: px;
width: 90%; /* Adjust width for responsiveness */
max-width: 500px; /* Limit the modal width */
padding: 0px;
position: absolute; /* Position relative to the modal container */
top: 50%; /* Center vertically */
left: 46.8%; /* Center horizontally */
transform: translate(-50%, -50%); /* Adjust for the modal's own dimensions */
text-align: left;
}    

.error {
border: 2px solid red;
background-color: #ffe6e6; /* Light red background */
}

</style>

    <style>

        /* Highlight the selected option */
#mailingAddressQuestion .selection-box div.selected {
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background-color: #007bff;
    color: white;
    align-self: flex-end;
    margin-top: 10px;
}

#editSSNButton {
        position: relative; /* Ensures the button stays in the same flow */
        margin-top: 10px; /* Adds spacing below the field */
    }

select:disabled {
    cursor: default; /* Ensures the cursor remains the default arrow */
}
details > summary {
    cursor: pointer; /* Change cursor to hand */
}

.button-container button {
    border: 1px solid #000000; /* Add a blue border */
    border-radius: 5px; /* Optional: Add rounded corners */
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; /* Smooth transition for hover effects */
}

.button-container button:hover {
    background-color: #0056b3; /* Darker blue background on hover */
    color: white; /* Ensure text is visible */
    border-color: #003f7f; /* Darker border color on hover */
}

.error {
    border: 2px solid red;
}

.household-member-info p {
    text-align: left; /* Ensure text is left-aligned */
    word-wrap: break-word; /* Allow long words to break and wrap */
    white-space: normal; /* Ensure normal wrapping behavior */
}
body {
    max-width: 1200px; /* Adjust the max-width as needed */
    margin: 0 auto;
    padding: 20px;
    margin-top: 60px; /* Adjust this value to match the height of the navigation container */

}
        
    </style>
    <style>
        .button-container {
                display: flex;
                gap: 10px; /* Adds spacing between buttons */
                flex-wrap: wrap; /* Ensures buttons wrap to the next line if needed */
            }
        
            .button-container button {
                flex: 1; /* Ensures buttons are evenly spaced */
                padding: 10px 15px;
            }

            /* Modal content styling */
.modal-content {
    background-color: #ffffff;
    border-radius: 10px;
    width: 100%;
    max-width: 500px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    position: relative;
    text-align: center;
}

.narrow-body {
        margin-left: 385px; /* Space for the left sidebar */
        margin-right: 10px; /* Optional: Space on the right */
        max-width: calc(100% - 395px); /* Ensure the body doesn't exceed the available space */
        margin: 0 auto; /* Center the content horizontally */
        margin-top: 60px; /* Adjust this value to match the height of the navigation container */
    }
        
            </style>
</head>
<body class="narrow-body">

    <h1>Applicant</h1>

     <!-- Add this container where you want the contacts to appear -->
     <div class="left-sidebar-container" id="contactsSidebarContainer">
        <div class="sidebar-header">
            <h2>Contacts</h2>
            <div class="button-container">
                <button id="add-contact-button" onclick="openContactModal()">Add New Contact</button>
            </div>
        </div>
        <div id="contacts-list" class="left-sidebar"></div>
    </div>

<!-- Modal for Adding/Editing Contacts -->
<div id="contactModal" class="contactmodal" style="display: none;">
    <div class="modal-content">
        <form id="contactForm">
            <h2 id="modal-title">Add Contact</h2>
            <label for="contactFirstName">First Name:</label>
            <input type="text" id="contactFirstName" required>

            <label for="contactLastName">Last Name:</label>
            <input type="text" id="contactLastName" required>

            <label for="contactPhoneNumber">Phone Number:</label>
            <input type="text" id="contactPhoneNumber" required>

            <label for="authorizedRepresentative">Authorized Representative:</label>
            <select id="authorizedRepresentative">
                <option value="N/A" selected>N/A</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </select>

            <div class="button-container">
                <button type="button" onclick="saveContact()">Save</button>
                <button type="button" onclick="closeContactModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>
    
<div id="notes-container">
    <textarea id="note-input" placeholder="Add Note..."></textarea>
    <button id="save-note">Save Note</button>
    <div id="notes-list">
        </div>
        </div>

        <div class="form-field">
            <label for="bestContactNumber">Best Contact Person:</label>
            <select id="bestContactNumber" name="bestContactNumber">
                <option value="" disabled selected>Select Best Contact</option>
            </select>
        </div>        

<!-- Address Fields -->
<div class="form-field">
    <label id="addressLabel" for="streetAddress">Street Address:</label>
    <input type="text" id="streetAddress" name="streetAddress" placeholder="Enter Street Address">
</div>

<div class="form-field">
    <label for="streetAddress2">Address Line 2:</label>
    <input type="text" id="streetAddress2" name="streetAddress2" placeholder="Enter Address Line 2">
</div>

<div class="form-field">
    <label for="city">City:</label>
    <input type="text" id="city" name="city" placeholder="Enter City">
</div>

<div class="form-field">
    <label for="state">State:</label>
    <select id="state" name="state">
        <option value="" disabled selected>Select State</option>
        <option value="PA">PA</option>
        <option value="AL">AL</option>
        <option value="AK">AK</option>
        <option value="AZ">AZ</option>
        <option value="AR">AR</option>
        <option value="CA">CA</option>
        <option value="CO">CO</option>
        <option value="CT">CT</option>
        <option value="DE">DE</option>
        <option value="FL">FL</option>
        <option value="GA">GA</option>
        <option value="HI">HI</option>
        <option value="ID">ID</option>
        <option value="IL">IL</option>
        <option value="IN">IN</option>
        <option value="IA">IA</option>
        <option value="KS">KS</option>
        <option value="KY">KY</option>
        <option value="LA">LA</option>
        <option value="ME">ME</option>
        <option value="MD">MD</option>
        <option value="MA">MA</option>
        <option value="MI">MI</option>
        <option value="MN">MN</option>
        <option value="MS">MS</option>
        <option value="MO">MO</option>
        <option value="MT">MT</option>
        <option value="NE">NE</option>
        <option value="NV">NV</option>
        <option value="NH">NH</option>
        <option value="NJ">NJ</option>
        <option value="NM">NM</option>
        <option value="NY">NY</option>
        <option value="NC">NC</option>
        <option value="ND">ND</option>
        <option value="OH">OH</option>
        <option value="OK">OK</option>
        <option value="OR">OR</option>
        <option value="RI">RI</option>
        <option value="SC">SC</option>
        <option value="SD">SD</option>
        <option value="TN">TN</option>
        <option value="TX">TX</option>
        <option value="UT">UT</option>
        <option value="VT">VT</option>
        <option value="VA">VA</option>
        <option value="WA">WA</option>
        <option value="WV">WV</option>
        <option value="WI">WI</option>
        <option value="WY">WY</option>
        <option value="DC">DC</option>
        <option value="PR">Puerto Rico</option>
        <option value="GU">Guam</option>
    </select>
</div>

<div class="form-field">
    <label for="zipCode">ZIP Code:</label>
    <input type="text" id="zipCode" name="zipCode" placeholder="Enter ZIP Code" maxlength="10">
</div>

    <div class="form-field">
        <label for="county">County:</label>
        <select id="county" name="county">
            <option value="" disabled selected>Select County</option>
            <option value="Adams">Adams</option>
            <option value="Allegheny">Allegheny</option>
            <option value="Armstrong">Armstrong</option>
            <option value="Beaver">Beaver</option>
            <option value="Bedford">Bedford</option>
            <option value="Berks">Berks</option>
            <option value="Blair">Blair</option>
            <option value="Bradford">Bradford</option>
            <option value="Bucks">Bucks</option>
            <option value="Butler">Butler</option>
            <option value="Cambria">Cambria</option>
            <option value="Cameron">Cameron</option>
            <option value="Carbon">Carbon</option>
            <option value="Centre">Centre</option>
            <option value="Chester">Chester</option>
            <option value="Clarion">Clarion</option>
            <option value="Clearfield">Clearfield</option>
            <option value="Clinton">Clinton</option>
            <option value="Columbia">Columbia</option>
            <option value="Crawford">Crawford</option>
            <option value="Cumberland">Cumberland</option>
            <option value="Dauphin">Dauphin</option>
            <option value="Delaware">Delaware</option>
            <option value="Elk">Elk</option>
            <option value="Erie">Erie</option>
            <option value="Fayette">Fayette</option>
            <option value="Forest">Forest</option>
            <option value="Franklin">Franklin</option>
            <option value="Fulton">Fulton</option>
            <option value="Greene">Greene</option>
            <option value="Huntingdon">Huntingdon</option>
            <option value="Indiana">Indiana</option>
            <option value="Jefferson">Jefferson</option>
            <option value="Juniata">Juniata</option>
            <option value="Lackawanna">Lackawanna</option>
            <option value="Lancaster">Lancaster</option>
            <option value="Lawrence">Lawrence</option>
            <option value="Lebanon">Lebanon</option>
            <option value="Lehigh">Lehigh</option>
            <option value="Luzerne">Luzerne</option>
            <option value="Lycoming">Lycoming</option>
            <option value="McKean">McKean</option>
            <option value="Monroe">Monroe</option>
            <option value="Montgomery">Montgomery</option>
            <option value="Montour">Montour</option>
            <option value="Northampton">Northampton</option>
            <option value="Northumberland">Northumberland</option>
            <option value="Perry">Perry</option>
            <option value="Philadelphia">Philadelphia</option>
            <option value="Pike">Pike</option>
            <option value="Potter">Potter</option>
            <option value="Schuylkill">Schuylkill</option>
            <option value="Snyder">Snyder</option>
            <option value="Somerset">Somerset</option>
            <option value="Sullivan">Sullivan</option>
            <option value="Susquehanna">Susquehanna</option>
            <option value="Tioga">Tioga</option>
            <option value="Union">Union</option>
            <option value="Venango">Venango</option>
            <option value="Warren">Warren</option>
            <option value="Washington">Washington</option>
            <option value="Wayne">Wayne</option>
            <option value="Westmoreland">Westmoreland</option>
            <option value="Wyoming">Wyoming</option>
            <option value="York">York</option>
        </select>
    </div>

    <div class="form-field" style="display: none;">
        <label for="schoolDistrict">School District:</label>
        <select id="schoolDistrict" name="schoolDistrict" disabled>
            <option value="" disabled selected>Select School District</option>
        </select>
    </div>

<!-- Mailing Address Selection -->
<div class="form-field" id="mailingAddressQuestion" style="display: block;">
    <label>Is this also your best mailing address?</label>
    <div class="selection-box">
        <div data-value="yes" onclick="toggleMailingAddress('yes')">Yes</div>
        <div data-value="no" onclick="toggleMailingAddress('no')">No</div>
    </div>
</div>

<!-- Mailing Address Fields -->
<div id="mailingAddressFields" style="display: none;">
    <div class="form-field">
        <label for="mailingStreetAddress">Mailing Address:</label>
        <input type="text" id="mailingStreetAddress" name="mailingStreetAddress" placeholder="Enter Mailing Address">
    </div>

    <div class="form-field">
        <label for="mailingStreetAddress2">Mailing Address Line 2:</label>
        <input type="text" id="mailingStreetAddress2" name="mailingStreetAddress2" placeholder="Enter Mailing Address Line 2">
    </div>

    <div class="form-field">
        <label for="mailingCity">Mailing City:</label>
        <input type="text" id="mailingCity" name="mailingCity" placeholder="Enter Mailing City">
    </div>

    <div class="form-field">
        <label for="mailingState">Mailing State:</label>
        <select id="mailingState" name="mailingState">
            <option value="" disabled selected>Select State</option>
            <option value="PA">PA</option>
            <option value="AL">AL</option>
            <option value="AK">AK</option>
            <option value="AZ">AZ</option>
            <option value="AR">AR</option>
            <option value="CA">CA</option>
            <option value="CO">CO</option>
            <option value="CT">CT</option>
            <option value="DE">DE</option>
            <option value="FL">FL</option>
            <option value="GA">GA</option>
            <option value="HI">HI</option>
            <option value="ID">ID</option>
            <option value="IL">IL</option>
            <option value="IN">IN</option>
            <option value="IA">IA</option>
            <option value="KS">KS</option>
            <option value="KY">KY</option>
            <option value="LA">LA</option>
            <option value="ME">ME</option>
            <option value="MD">MD</option>
            <option value="MA">MA</option>
            <option value="MI">MI</option>
            <option value="MN">MN</option>
            <option value="MS">MS</option>
            <option value="MO">MO</option>
            <option value="MT">MT</option>
            <option value="NE">NE</option>
            <option value="NV">NV</option>
            <option value="NH">NH</option>
            <option value="NJ">NJ</option>
            <option value="NM">NM</option>
            <option value="NY">NY</option>
            <option value="NC">NC</option>
            <option value="ND">ND</option>
            <option value="OH">OH</option>
            <option value="OK">OK</option>
            <option value="OR">OR</option>
            <option value="RI">RI</option>
            <option value="SC">SC</option>
            <option value="SD">SD</option>
            <option value="TN">TN</option>
            <option value="TX">TX</option>
            <option value="UT">UT</option>
            <option value="VT">VT</option>
            <option value="VA">VA</option>
            <option value="WA">WA</option>
            <option value="WV">WV</option>
            <option value="WI">WI</option>
            <option value="WY">WY</option>
            <option value="DC">DC</option>
            <option value="PR">Puerto Rico</option>
            <option value="GU">Guam</option>
        </select>
    </div>

    <div class="form-field">
        <label for="mailingZipCode">Mailing ZIP Code:</label>
        <input type="text" id="mailingZipCode" name="mailingZipCode" placeholder="Enter Mailing ZIP Code" maxlength="10">
    </div>
</div>

<div class="form-field">
    <label for="emailAddress">Do you have an email address?</label>
    <input type="email" id="emailAddress" name="emailAddress" placeholder="Enter Email Address">

    <div id="householdMemberContainer" class="household-member-container"></div>

    <div class="button-container">
        <button id="add-household-member" style="display: none;">Add Household Member</button>
        <button id="save-exit" onclick="redirectToHouseholdView()">Save and Release Profile</button>
        <button id="save-continue" onclick="goToRelationshipsEdit()">Save and Continue</button> <br>
    </div>

<!-- Add this to your HTML -->
<div id="loading-indicator" style="display: none;">Loading...</div>

<div id="householdMemberModal" class="modal">
    <div class="modal-content">
        <form id="householdMemberForm">

            <h2 id="modal-header">Add Household Member</h2>


            <input type="hidden" id="householdMemberId">
<!-- Prefix Dropdown -->
<label for="prefix">Prefix:</label>
<select id="prefix" name="prefix">
    <option value="" disabled selected>Select Prefix</option>
    <option value="">NONE</option>
    <option value="BR">BR</option>
    <option value="FTHR">FATHR</option>
    <option value="MTHR">MTHR</option>
    <option value="REB">REB</option>
    <option value="REV">REV</option>
    <option value="SR">SR</option>
</select><br><br>

<!-- First Name -->
<label for="firstName">First Name:</label>
<input type="text" id="firstName" name="firstName"><br><br>

<!-- Middle Initial -->
<label for="middleInitial">Middle Initial:</label>
<input type="text" id="middleInitial" name="middleInitial"><br><br>

<!-- Last Name -->
<label for="lastName">Last Name:</label>
<input type="text" id="lastName" name="lastName"><br><br>

<!-- Suffix Dropdown -->
<label for="suffix">Suffix:</label>
<select id="suffix" name="suffix">
    <option value="" disabled selected>Select Suffix</option>
    <option value="">NONE</option>
    <option value="JR">JR</option>
    <option value="SR">SR</option>
    <option value="I">I</option>
    <option value="II">II</option>
    <option value="III">III</option>
    <option value="IV">IV</option>
    <option value="V">V</option>
    <option value="VI">VI</option>
    <option value="VII">VII</option>
</select><br><br>
            <div class="selection-box">
                <label for="dob">Date of Birth:</label>
                <input type="date" id="dob" name="dob" class="selection-box-input" style="pointer-events: none; background-color: #e9ecef;"><br><br>            </div>
            <div class="selection-box">
                <label for="legalSex">Legal Sex:</label>
                <select id="legalSex" name="legalSex" class="selection-box-input" readonly>
                    <option value="" disabled selected>Select Legal Sex</option>
                    <option value="MALE">MALE</option>
                    <option value="FEMALE">FEMALE</option>
                    </select><br><br>
            </div>


            <div class="selection-box">
                <label for="maritalStatus">Current Marital Status:</label>
                <select id="maritalStatus" name="maritalStatus" class="selection-box-input" readonly>
                    <option value="" disabled selected>Select Marital Status</option>
                    <option value="Single">Single</option>
                    <option value="Married (Living Together)">Married (Living Together)</option>
                    <option value="Married (Living Separately)">Married (Living Separately)</option>
                    <option value="Divorced">Divorced</option>
                    <option value="Widowed">Widowed</option>
                </select><br><br>
            </div>
            <div class="selection-box" id="previousMaritalStatusContainer" style="display: none;">
                <label for="previousMaritalStatus">Previous Year Marital Status:</label>
                <select id="previousMaritalStatus" name="previousMaritalStatus" class="selection-box-input" readonly>
                    <option value="" disabled selected>Select Previous Year Marital Status</option>
                    <option value="Single">Single</option>
                    <option value="Married (Living Together)">Married (Living Together)</option>
                    <option value="Married (Living Separately)">Married (Living Separately)</option>
                    <option value="Divorced">Divorced</option>
                    <option value="Widowed">Widowed</option>
                </select><br><br>
            </div>

<label for="socialSecurityNumber">Social Security Number:</label>
<input 
    type="text" 
    id="socialSecurityNumber" 
    name="socialSecurityNumber" 
    placeholder="xxx-xx-xxxx" 
    maxlength="11" 
    oninput="formatSSN(this)" 
    >
<button type="button" id="nextSSNButton" onclick="showConfirmSSN()" style="display: none;">Next</button><br><br>

<div id="confirmSSNContainer" style="display: none;">
    <label for="confirmSocialSecurityNumber">Confirm Social Security Number:</label>
    <input 
        type="text" 
        id="confirmSocialSecurityNumber" 
        name="confirmSocialSecurityNumber" 
        placeholder="xxx-xx-xxxx" 
        maxlength="11" 
        oninput="formatSSN(this)" 
    >
    <button type="button" id="confirmSSNButton" onclick="confirmSSN()" style="display: none;">Confirm</button>
    <button type="button" id="editSSNButton" onclick="editSSN()" style="display: none;">Edit SSN</button>
</div>

<label for="driversLicenseNumber">Driver's License Number:</label>
<input type="text" id="driversLicenseNumber" name="driversLicenseNumber" placeholder="Enter Driver's License Number">

<div id="disabilityQuestion" class="selection-box">
    <label>Is this person receiving disability benefits?</label>
    <div id="modal-disability-yes" data-value="yes" style="pointer-events: none; opacity: 0.5;">Yes</div>
    <div id="modal-disability-no" data-value="no" style="pointer-events: none; opacity: 0.5;">No</div>
</div>
<div id="medicareQuestion" class="selection-box">
    <label>Is this person enrolled in Medicare (or will they be within the next three months)?</label>
    <div id="modal-medicare-yes" data-value="yes" style="pointer-events: none; opacity: 0.5;">Yes</div>
    <div id="modal-medicare-no" data-value="no" style="pointer-events: none; opacity: 0.5;">No</div>
</div>
<div id="medicaidQuestion" class="selection-box">
    <label>Is this person enrolled in Medicaid?</label>
    <div id="modal-medicaid-yes" data-value="yes" style="pointer-events: none; opacity: 0.5;">Yes</div>
    <div id="modal-medicaid-no" data-value="no" style="pointer-events: none; opacity: 0.5;">No</div>
</div>
<div id="citizenQuestion" class="selection-box">
    <label>Is this person a U.S. citizen?</label>
    <div id="modal-citizen-yes" data-value="yes" style="pointer-events: none; opacity: 0.5;">Yes</div>
    <div id="modal-citizen-no" data-value="no" style="pointer-events: none; opacity: 0.5;">No</div>
</div>
<div id="nonCitizenStatusContainer" style="display: none; margin-top: 10px;">
    <label for="nonCitizenStatus">Select Non-Citizenship Status:</label>
    <select id="nonCitizenStatus" disabled>
        <option value="" disabled selected>Select status</option>
        <option value="Lawful Permanent Resident (5+ Years)">Lawful Permanent Resident (5+ Years)</option>
        <option value="Refugee">Refugee</option>
        <option value="Asylee">Asylee</option>
        <option value="Person Whose Deportation is Withheld">Person Whose Deportation is Withheld</option>
        <option value="Conditional Entrant (5+ Years)">Conditional Entrant (5+ Years)</option>
        <option value="Victim of Severe Trafficking">Victim of Severe Trafficking</option>
        <option value="Cuban or Haitian Entrant">Cuban or Haitian Entrant</option>
        <option value="Iraqi or Afghan Special Immigrant">Iraqi or Afghan Special Immigrant</option>
        <option value="Child Under 18 in Qualified Non-Citizen Category">Child Under 18 in Qualified Non-Citizen Category</option>
        <option value="Hmong or Highland Laotian Tribal Members">Hmong or Highland Laotian Tribal Members</option>
        <option value="Citizen of Micronesia, Marshall Islands, or Palau">Citizen of Micronesia, Marshall Islands, or Palau</option>
        <option value="Amerasian">Amerasian</option>
        <option value="Person Paroled in the U.S. (1+ Years)">Person Paroled in the U.S. (1+ Years)</option>
        <option value="Non-Citizen Who is Blind or Disabled and Receiving Disability Benefits">Non-Citizen Who is Blind or Disabled and Receiving Disability Benefits</option>
        <option value="Non-Citizen Who Was 65+ and Lawfully Residing in the U.S. on August 22, 1996">Non-Citizen Who Was 65+ and Lawfully Residing in the U.S. on August 22, 1996</option>
        <option value="Ineligible Non-Citizen">Ineligible Non-Citizen</option>
    </select>
</div>
<div id="studentQuestion" class="selection-box">
    <label>Is this person a student?</label>
    <div id="modal-student-yes" data-value="yes" style="pointer-events: none; opacity: 0.5;">Yes</div>
    <div id="modal-student-no" data-value="no" style="pointer-events: none; opacity: 0.5;">No</div>
</div>
<div id="studentStatusContainer" style="display: none; margin-top: 10px;">
    <label for="studentStatus">Select Student Status:</label>
    <select id="studentStatus" disabled>
        <option value="" disabled selected>Select status</option>
        <option value="Enrolled Less than Half-Time">Enrolled Less than Half-Time</option>
        <option value="Under Age 18">Under Age 18</option>
        <option value="High School Student">High School Student</option>
        <option value="Age 50 or Older">Age 50 or Older</option>
        <option value="Physically or Mentally Unfit for Employment">Physically or Mentally Unfit for Employment</option>
        <option value="Employed at Least 20 Hours Per Week">Employed at Least 20 Hours Per Week</option>
        <option value="Participating in a Work Study Program">Participating in a Work Study</option>
        <option value="Participating in a Job Training Program">Participating in a Job Training Program</option>
        <option value="Assigned to or Placed in College through a SNAP Employment or Training Program">Assigned to or Placed in College through a SNAP Employment or Training Program</option>
        <option value="Responsible for the Care of a Child Under 6">Responsible for the Care of a Child Under 6</option>
        <option value="Responsible for the Care of a Child Aged 6-12 and No Adequate Child Care Available">Responsible for the Care of a Child Aged 6-12 and No Adequate Child Care Available</option>
        <option value="Single Parent Enrolled Full-Time and Responsible for a Child Under 12">Single Parent Enrolled Full-Time and Responsible for a Child Under 12</option>
        <option value="TANF Recipient">TANF Recipient</option>
        <option value="Ineligible Student">Ineligible Student</option>
    </select></div>

    <div id="mealsQuestion" class="selection-box">
        <label>Is this person included in the SNAP household?</label>
        <div id="modal-meals-yes" data-value="yes">Yes</div>
        <div id="modal-meals-no" data-value="no">No</div>
    </div>

            <button type="button" id="add-member" class="submit-button">Add Member</button>

        </form>

    <script>
// Utility function to get query parameters
function getQueryParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

        function goToRelationshipsEdit() {
    const clientId = getQueryParameter('id');
    if (clientId) {
        window.location.href = `relationshipsedit.html?id=${clientId}`;
    } else {
        console.error('Client ID not found in query parameters.');
    }
}

async function loadClientData() {
    const clientId = getQueryParam('id'); // Get the client ID from the URL

    try {
        const response = await fetch(`/get-client/${clientId}`); // Fetch client data
        if (!response.ok) {
            throw new Error(`Failed to fetch client: ${response.statusText}`);
        }

        const client = await response.json(); // Parse the client data
        if (client && client.county) {
            console.log('Client data loaded:', client);

            // Populate the county dropdown with the preexisting value
            const countyDropdown = document.getElementById('county');
            countyDropdown.value = client.county; // Set the dropdown value
            console.log(`County dropdown set to: ${client.county}`);

            // Populate the school district dropdown based on the preexisting county
            populateSchoolDistricts(client.county);

            // Wait for the school district dropdown to populate, then set its value
            setTimeout(() => {
                if (client.schoolDistrict) {
                    const schoolDistrictDropdown = document.getElementById('schoolDistrict');
                    schoolDistrictDropdown.value = client.schoolDistrict;
                    console.log(`School district dropdown set to: ${client.schoolDistrict}`);
                }
            }, 0); // Use a short delay to ensure the dropdown is populated

            // Update the label for Street Address based on homelessness status
            const addressLabel = document.getElementById('addressLabel');
            const mailingAddressQuestion = document.getElementById('mailingAddressQuestion');
            if (client.homelessness === 'yes') {
                addressLabel.textContent = 'Mailing Address:';
                mailingAddressQuestion.style.display = 'none';
            } else {
                addressLabel.textContent = 'Street Address:';
                mailingAddressQuestion.style.display = 'block';
            }
        } else {
            console.error('Client data is missing or county is not defined.');
        }
    } catch (error) {
        console.error('Error loading client data:', error);
    }
}

// Populate the school district dropdown based on the selected county
function populateSchoolDistricts(county) {
    const schoolDistrictDropdown = document.getElementById('schoolDistrict');

    // Clear existing options
    schoolDistrictDropdown.innerHTML = '<option value="" disabled selected>Select School District</option>';

    // Get the school districts for the selected county
    const districts = schoolDistricts[county] || [];

    // Enable the dropdown if districts are available
    if (districts.length > 0) {
        schoolDistrictDropdown.disabled = false;

        // Add the districts as options
        districts.forEach(district => {
            const option = document.createElement('option');
            option.value = district;
            option.textContent = district;
            schoolDistrictDropdown.appendChild(option);
        });
    } else {
        // Disable the dropdown if no districts are available
        schoolDistrictDropdown.disabled = true;
    }
}

// Ensure the script runs after the DOM is fully loaded
document.addEventListener('DOMContentLoaded', () => {
    loadClientData();
});

const schoolDistricts = {
    "Adams": ["Bermudian Springs School District", "Conewago Valley School District", "Fairfield Area School District", "Gettysburg Area School District", "Littlestown Area School District", "Upper Adams School District"],
    "Allegheny": ["Allegheny Valley School District", "Avonworth School District", "Baldwin-Whitehall School District", "Bethel Park School District", "Brentwood Borough School District"],
    "Armstrong": ["Apollo-Ridge School District", "Armstrong School District", "Bradys Bend Area School District", "Kittanning Area School District", "Leechburg Area School District"],
    "Beaver": ["Aliquippa School District", "Ambridge Area School District", "Beaver Area School District", "Blackhawk School District", "Center Area School District"],
    "Bedford": ["Bedford Area School District", "Everett Area School District", "Fulton County School District", "Northern Bedford County School District", "Southern Bedford County School District"],
    "Berks": ["Antietam School District", "Boyertown Area School District", "Brandywine Heights Area School District", "Daniel Boone Area School District", "East Penn School District"],
    "Blair": ["Altoona Area School District", "Bellwood-Antis School District", "Claysburg-Kimmel School District", "Hollidaysburg Area School District", "Juniata Valley School District"],
    "Bradford": ["Athens Area School District", "Bradford Area School District", "Canton Area School District", "Sayre Area School District", "Troy Area School District"],
    "Bucks": ["Bensalem Township School District", "Bristol Borough School District", "Bristol Township School District", "Buckingham Township School District", "Central Bucks School District"],
    "Butler": ["Butler Area School District", "Cabot School District", "Connoquenessing Area School District", "Hampton Township School District", "Mars Area School District"],
    "Cambria": ["Cambria Heights School District", "Conemaugh Valley School District", "Ferndale Area School District", "Greater Johnstown School District", "Northern Cambria School District"],
    "Cameron": ["Cameron County School District"],
    "Carbon": ["Lehighton Area School District", "Palmerton Area School District", "Souderton Area School District", "Weatherly Area School District"],
    "Centre": ["Bellefonte Area School District", "State College Area School District", "Philipsburg-Osceola Area School District"],
    "Chester": ["Avon Grove School District", "Coatesville Area School District", "Downingtown Area School District", "Great Valley School District", "Kennett Consolidated School District"],
    "Clarion": ["Clarion Area School District", "Eldred School District", "Forest Area School District", "Keystone School District", "Redbank Valley School District"],
    "Clearfield": ["Curwensville Area School District", "DuBois Area School District", "Graffius School District", "Moshannon Valley School District", "West Branch Area School District"],
    "Clinton": ["Clinton County School District", "Muncy School District"],
    "Columbia": ["Berwick Area School District", "Bloomsburg Area School District", "Central Columbia School District", "Danville Area School District", "Millville Area School District"],
    "Crawford": ["Cranberry Area School District", "Conneaut Area School District", "Linesville Area School District", "Meadville Area School District", "Northwestern School District"],
    "Cumberland": ["Cumberland Valley School District", "East Pennsboro Area School District", "Shippensburg Area School District", "South Middleton School District", "West Shore School District"],
    "Dauphin": ["Central Dauphin School District", "Dauphin County Technical School", "Halifax Area School District", "Harrisburg School District", "Lower Dauphin School District"],
    "Delaware": ["Chichester School District", "Concord School District", "Delaware County Technical School", "Garnet Valley School District", "Haverford Township School District"],
    "Elk": ["Elk County School District"],
    "Erie": ["Corry Area School District", "Erie City School District", "Fairview School District", "Fort LeBoeuf School District", "Girard School District"],
    "Fayette": ["Albert Gallatin Area School District", "Brownsville Area School District", "Connellsville Area School District", "Fayette County Area School District", "Uniontown Area School District"],
    "Forest": ["Forest Area School District"],
    "Franklin": ["Chambersburg Area School District", "Fannett-Metal School District", "Greencastle-Antrim School District", "Shippensburg Area School District"],
    "Fulton": ["Fulton County School District"],
    "Greene": ["Greene County School District", "Jefferson-Morgan School District"],
    "Huntingdon": ["Huntingdon Area School District", "Mount Union Area School District", "Southern Huntingdon County School District"],
    "Indiana": ["Indiana Area School District", "Penns Manor Area School District", "Purchase Line School District"],
    "Jefferson": ["Brookville Area School District", "DuBois Area School District", "Punxsutawney Area School District"],
    "Juniata": ["Juniata County School District"],
    "Lackawanna": ["Carbondale Area School District", "Lakeland School District", "Mid Valley School District", "North Pocono School District", "Scranton School District"],
    "Lancaster": ["Conestoga Valley School District", "Cocalico School District", "Columbia Borough School District", "Donegal School District", "Ephrata Area School District"],
    "Lawrence": ["Ellwood City Area School District", "Lawrence County School District", "Neshannock Township School District"],
    "Lebanon": ["Annville-Cleona School District", "Cornwall-Lebanon School District", "Eastern Lebanon County School District", "Lebanon School District", "Northern Lebanon School District"],
    "Lehigh": ["Allentown School District", "Catasauqua Area School District", "East Penn School District", "Northern Lehigh School District", "Parkland School District"],
    "Luzerne": ["Dallas School District", "Hazleton Area School District", "Kingston Area School District", "Lake-Lehman School District", "Nanticoke Area School District"],
    "Lycoming": ["Canton Area School District", "Muncy School District", "South Williamsport Area School District", "Wellsboro Area School District"],
    "McKean": ["Bradford Area School District", "Cameron County School District", "Port Allegany School District"],
    "Monroe": ["East Stroudsburg Area School District", "Pleasant Valley School District", "Stroudsburg Area School District"],
    "Montgomery": ["Abington School District", "Cheltenham Township School District", "Hatboro-Horsham School District", "Lower Merion School District", "Methacton School District"],
    "Montour": ["Montour School District"],
    "Northampton": ["Bethlehem Area School District", "Easton Area School District", "Nazareth Area School District", "Northampton Area School District", "Pen Argyl Area School District"],
    "Northumberland": ["Danville Area School District", "Line Mountain School District", "Milton Area School District", "Shamokin Area School District", "Warrior Run School District"],
    "Perry": ["Duncannon Borough School District", "Newport School District", "Susquenita School District"],
    "Philadelphia": ["Philadelphia City School District"],
    "Pike": ["Delaware Valley School District", "Wallenpaupack Area School District"],
    "Potter": ["Coudersport Area School District", "Oswayo Valley School District"],
    "Schuylkill": ["Blue Mountain School District", "Mahanoy Area School District", "Minersville Area School District", "North Schuylkill School District", "Pottsville Area School District"],
    "Snyder": ["Middleburg Area School District", "Selinsgrove Area School District", "Shamokin Dam Area School District"],
    "Somerset": ["Conemaugh Township Area School District", "North Star School District", "Rockwood Area School District", "Somerset Area School District"],
    "Sullivan": ["Sullivan County School District"],
    "Susquehanna": ["Forest City Regional School District", "Montrose Area School District"],
    "Tioga": ["Elkland Area School District", "Wellsboro Area School District"],
    "Union": ["Lewisburg Area School District", "Mifflinburg Area School District"],
    "Venango": ["Cranberry Area School District", "Franklin Area School District", "Oil City Area School District"],
    "Warren": ["Warren County School District"],
    "Washington": ["Bentleyville School District", "California Area School District", "Charleroi Area School District", "Fort Cherry School District", "McGuffey School District"],
    "Wayne": ["Honesdale School District", "Wallenpaupack Area School District"],
    "Westmoreland": ["Derry Area School District", "Greensburg-Salem School District", "Hempfield Area School District", "Jeannette City School District", "Latrobe Area School District"],
    "Wyoming": ["Tunkhannock Area School District"],
    "York": ["Central York School District", "Dallastown Area School District", "Eastern York School District", "Hanover Public School District", "Red Lion Area School District"]
};

// Ensure the script runs after the DOM is fully loaded
document.addEventListener('DOMContentLoaded', () => {
    loadClientData();

    // Add a listener for the county dropdown
    const countyDropdown = document.getElementById('county');
    countyDropdown.addEventListener('change', (event) => {
        const selectedCounty = event.target.value;

        // Repopulate the district list based on the selected county
        populateSchoolDistricts(selectedCounty);

        // Save the selected county to the backend
        updateClientData('county', selectedCounty);

        // Clear the district value in the client array
        updateClientData('schoolDistrict', '');
    });

    // Add a listener for the school district dropdown
    const schoolDistrictDropdown = document.getElementById('schoolDistrict');
    schoolDistrictDropdown.addEventListener('change', (event) => {
        const selectedDistrict = event.target.value;

        // Save the selected school district to the backend
        updateClientData('schoolDistrict', selectedDistrict);
    });
});

// Function to update the client data
function updateClientData(key, value) {
    const clientId = getQueryParam('id'); // Get the client ID from the URL

    if (!clientId) {
        console.error('Client ID not found in query parameters.');
        return;
    }

    const requestBody = {
        clientId,
        clientData: { [key]: value }, // Dynamically set the key and value
    };

    // Update the client data via REST API
    fetch(`/update-client`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody),
    })
        .then((response) => {
            if (response.ok) {
                console.log(`Client ${key} updated to: ${value}`);
            } else {
                return response.json().then((error) => {
                    console.error('Error details:', error);
                    throw new Error(`Failed to update client data: ${error.message}`);
                });
            }
        })
        .catch((error) => {
            console.error('Error updating client data:', error);
        });
}

function redirectToHouseholdView() {
    const clientId = getQueryParam('id');
    if (clientId) {
        const userConfirmed = confirm("Are you sure you want to save and release the profile?");
        if (userConfirmed) {
            const requestBody = {
                clientId,
                clientData: { screeningInProgress: false },
            };

            console.log('Request body:', requestBody); // Log the request body for debugging

            // Update screeningInProgress to false in the database via REST API
            fetch(`/update-client`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody),
            })
                .then((response) => {
                    if (response.ok) {
                        console.log('screeningInProgress set to false for client:', clientId);
                        
                    } else {
                        return response.json().then((error) => {
                            console.error('Error details:', error);

                            // Check if the error message indicates no changes were made
                            if (error.message === 'No changes were made to the client data.') {
                                console.log('No changes were made, but proceeding with redirect.');
                            } else {
                                throw new Error(`Failed to update client data: ${error.message}`);
                            }
                        });
                    }
                })
                .catch((error) => {
                    console.error('Error updating client data:', error);
                })
                .finally(() => {
                    // Redirect to the household view page regardless of success or failure
                    window.location.href = `householdview.html?id=${clientId}`;
                });
        } else {
            console.log("User canceled the action.");
        }
    } else {
        console.error('Client ID not found in query parameters.');
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    console.log('DOMContentLoaded event fired'); // Debugging log
    await toggleSchoolDistrictField();
});

// Function to check PTRR application state and toggle the school district field
async function toggleSchoolDistrictField() {
    console.log('toggleSchoolDistrictField function called'); // Debugging log
    const schoolDistrictField = document.querySelector('.form-field select#schoolDistrict').parentElement;

    const clientId = getQueryParam('id'); // Get the client ID from the URL
    try {
        const response = await fetch(`/get-client/${clientId}`);
        if (!response.ok) {
            throw new Error(`Failed to fetch client data: ${response.statusText}`);
        }
        const client = await response.json();
        console.log('Client data:', client); // Debugging log

        // Check if PTRR is applying
        const isPTRRApplying = client.householdMembers?.some(member =>
            member.PTRR?.application?.some(app => app.applying === true)
        );
        console.log('isPTRRApplying:', isPTRRApplying); // Debugging log

        if (isPTRRApplying) {
            // Show and enable the school district field
            schoolDistrictField.style.display = 'block';
            const schoolDistrictDropdown = document.getElementById('schoolDistrict');
            schoolDistrictDropdown.disabled = false;
            schoolDistrictDropdown.required = true;
        } else {
            // Hide and disable the school district field
            schoolDistrictField.style.display = 'none';
            const schoolDistrictDropdown = document.getElementById('schoolDistrict');
            schoolDistrictDropdown.disabled = true;
            schoolDistrictDropdown.required = false;
        }
    } catch (error) {
        console.error('Error toggling school district field:', error);
    }
}

// Function to toggle the visibility of the "Previous Year Marital Status" dropdown
async function togglePreviousMaritalStatusDropdown() {
    const clientId = getQueryParam('id'); // Get the client ID from the URL

    try {
        const response = await fetch(`/get-client/${clientId}`); // Fetch client data
        if (!response.ok) {
            throw new Error(`Failed to fetch client data: ${response.statusText}`);
        }

        const client = await response.json(); // Parse the client data
        const members = client.householdMembers || []; // Get household members

        // Check if any member has PTRR - application - applying: true
        const hasPTRRApplying = members.some(member =>
            member.PTRR?.application?.some(app => app.applying === true)
        );

        // Get the dropdown container
        const previousMaritalStatusContainer = document.getElementById('previousMaritalStatusContainer');

        // Show or hide the dropdown based on the `applying` status
        if (hasPTRRApplying) {
            previousMaritalStatusContainer.style.display = 'block'; // Show the dropdown
        } else {
            previousMaritalStatusContainer.style.display = 'none'; // Hide the dropdown
        }
    } catch (error) {
        console.error('Error toggling Previous Year Marital Status dropdown:', error);
    }
}

// Ensure the script runs after the DOM is fully loaded
document.addEventListener('DOMContentLoaded', () => {
    togglePreviousMaritalStatusDropdown(); // Check and toggle the dropdown visibility
});

function resetSSNFields() {
    const ssnLabel = document.querySelector('label[for="socialSecurityNumber"]');
    const ssnInput = document.getElementById('socialSecurityNumber');
    const nextButton = document.getElementById('nextSSNButton');
    const confirmSSNContainer = document.getElementById('confirmSSNContainer');
    const confirmSSNInput = document.getElementById('confirmSocialSecurityNumber');

    // Reset visibility
    ssnLabel.style.display = 'block';
    ssnInput.style.display = 'block';
    nextButton.style.display = 'inline-block';
    confirmSSNContainer.style.display = 'none';

    // Clear input values
    ssnInput.value = '';
    confirmSSNInput.value = '';
}

function formatSSN(input) {
    const nextButton = document.getElementById('nextSSNButton');

    // Remove all non-digit characters
    let value = input.value.replace(/\D/g, '');

    // Format the value as ###-##-####
    if (value.length > 3 && value.length <= 5) {
        value = `${value.slice(0, 3)}-${value.slice(3)}`;
    } else if (value.length > 5) {
        value = `${value.slice(0, 3)}-${value.slice(3, 5)}-${value.slice(5, 9)}`;
    }

    // Set the formatted value back to the input
    input.value = value;

    // Only show the "Next" button for the initial SSN field
    if (input.id === 'socialSecurityNumber') {
        if (value.length === 11) {
            nextButton.style.display = 'inline-block';
        } else {
            nextButton.style.display = 'none';
        }
    }
}

function validateConfirmSSN() {
    const ssnInput = document.getElementById('socialSecurityNumber');
    const confirmSSNInput = document.getElementById('confirmSocialSecurityNumber');
    const confirmButton = document.getElementById('confirmSSNButton');
    const editSSNButton = document.getElementById('editSSNButton');

    // Check if the confirm SSN field has 11 characters
    if (confirmSSNInput.value.length === 11) {
        if (confirmSSNInput.value !== ssnInput.value) {
            alert('The Social Security Numbers entered do not match. Please try again.');
            resetSSNFields(); // Reset both fields
        } else {
            // Enable the "Confirm" button
            confirmButton.style.display = 'inline-block';
        }
    } else {
        // Hide the "Confirm" button if the input is incomplete
        confirmButton.style.display = 'none';
    }
}

function confirmSSN() {
    const ssnInput = document.getElementById('socialSecurityNumber');
    const confirmSSNInput = document.getElementById('confirmSocialSecurityNumber');
    const confirmButton = document.getElementById('confirmSSNButton');
    const editSSNButton = document.getElementById('editSSNButton');

    // Make the SSN fields read-only
    ssnInput.classList.add('override-readonly');
    confirmSSNInput.readOnly = true;

    // Hide the "Confirm" button and show the "Edit SSN" button
    confirmButton.style.display = 'none';
    editSSNButton.style.display = 'inline-block';
}

function editSSN() {
    const ssnInput = document.getElementById('socialSecurityNumber');
    const confirmSSNInput = document.getElementById('confirmSocialSecurityNumber');
    const confirmButton = document.getElementById('confirmSSNButton');
    const editSSNButton = document.getElementById('editSSNButton');

    // Make the SSN fields editable
    ssnInput.classList.remove('override-readonly');    confirmSSNInput.readOnly = false;

    // Reset the fields
    resetSSNFields();

    // Hide the "Edit SSN" button
    editSSNButton.style.display = 'none';
}

document.addEventListener('DOMContentLoaded', async () => {
    const clientId = getQueryParam('id'); // Get the client ID from the URL

    try {
        const response = await fetch(`/get-client/${clientId}`);
        if (!response.ok) {
            throw new Error(`Failed to fetch client data: ${response.statusText}`);
        }

        const client = await response.json();

        // Populate the address fields with pre-existing data
        document.getElementById('streetAddress').value = client.streetAddress || '';
        document.getElementById('streetAddress2').value = client.streetAddress2 || '';
        document.getElementById('city').value = client.city || '';
        document.getElementById('state').value = client.state || '';
        document.getElementById('zipCode').value = client.zipCode || '';
    } catch (error) {
        console.error('Error loading client data:', error);
    }
});

// Utility function to get query parameters
function getQueryParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// Add an event listener to the confirm SSN field
document.getElementById('confirmSocialSecurityNumber').addEventListener('input', function () {
    validateConfirmSSN();
});

// Utility function to get query parameters
function getQueryParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// Save data to the database
function saveToDatabase(field, value) {
    const clientId = getQueryParam('id');
    if (!clientId) {
        console.error('Client ID not found in query parameters.');
        return;
    }

    const requestBody = {
        clientId,
        clientData: { [field]: value },
    };

    fetch(`/update-client`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody),
    })
        .then((response) => {
            if (response.ok) {
                console.log(`Client ${field} updated to: ${value}`);
            } else {
                return response.json().then((error) => {
                    console.error('Error details:', error);
                    throw new Error(`Failed to update client data: ${error.message}`);
                });
            }
        })
        .catch((error) => console.error('Error updating client data:', error));
}

// Populate form fields with client data
function populateFormFields(client) {
    Object.entries(client).forEach(([key, value]) => {
        const field = document.getElementById(key);
        if (field) {
            if (field.tagName === 'SELECT' || field.tagName === 'INPUT') {
                field.value = value || '';
            }
        }
    });
}

// Handle homelessness logic
function handleHomelessness(isHomeless) {
    const addressLabel = document.getElementById('addressLabel');
    const mailingAddressQuestion = document.getElementById('mailingAddressQuestion');

    if (isHomeless === 'yes') {
        addressLabel.textContent = 'Mailing Address:';
        mailingAddressQuestion.style.display = 'none';
    } else {
        addressLabel.textContent = 'Street Address:';
        mailingAddressQuestion.style.display = 'block';
    }
}

// Toggle mailing address fields and save the selection to the backend
function toggleMailingAddress(value) {
    const mailingAddressFields = document.getElementById('mailingAddressFields');
    const mailingAddressYes = document.querySelector('#mailingAddressQuestion [data-value="yes"]');
    const mailingAddressNo = document.querySelector('#mailingAddressQuestion [data-value="no"]');

    // Update the UI based on the selected value
    if (value === 'yes') {
        mailingAddressFields.style.display = 'none';
        mailingAddressYes.classList.add('selected');
        mailingAddressNo.classList.remove('selected');

                // Clear the fields in the UI
                document.getElementById('mailingStreetAddress').value = '';
        document.getElementById('mailingStreetAddress2').value = '';
        document.getElementById('mailingCity').value = '';
                document.getElementById('mailingZipCode').value = '';


        // Set all mailing address details to null in the backend
        saveToDatabase('mailingStreetAddress', null);
        saveToDatabase('mailingStreetAddress2', null);
        saveToDatabase('mailingCity', null);
        saveToDatabase('mailingState', null);
        saveToDatabase('mailingZipCode', null);
    } else {
        mailingAddressFields.style.display = 'block';
        mailingAddressYes.classList.remove('selected');
        mailingAddressNo.classList.add('selected');
    }

    // Save the selection to the backend
    saveToDatabase('mailingAddressSameAsResidential', value);
}

// Restore the selected mailing address option on page load
async function restoreMailingAddressSelection() {
    const clientId = getQueryParam('id');
    if (!clientId) {
        console.error('Client ID not found in query parameters.');
        return;
    }

    try {
        const response = await fetch(`/get-client/${clientId}`);
        if (!response.ok) {
            throw new Error(`Failed to fetch client data: ${response.statusText}`);
        }

        const client = await response.json();
        const savedValue = client.mailingAddressSameAsResidential;

        // Restore the UI based on the saved value
        if (savedValue) {
            toggleMailingAddress(savedValue);
        }
    } catch (error) {
        console.error('Error restoring mailing address selection:', error);
    }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', () => {
    restoreMailingAddressSelection(); // Restore the selection on page load
});

// Add event listeners to form fields
function addFieldListeners() {
    const fields = document.querySelectorAll('input, select, textarea');
    fields.forEach((field) => {
        // Exclude fields inside modals
        if (!field.closest('.contactmodal') && !field.closest('.modal')) {
            field.addEventListener('change', (event) => {
                saveToDatabase(event.target.id, event.target.value);
            });
        }
    });
}

async function saveHouseholdMember() {
    const householdMemberId = document.getElementById('householdMemberId').value;
    const prefix = document.getElementById('prefix').value;
    const firstName = document.getElementById('firstName').value.trim();
    const middleInitial = document.getElementById('middleInitial').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const suffix = document.getElementById('suffix').value;
    const dob = document.getElementById('dob').value;
    const legalSex = document.getElementById('legalSex').value;

    if (!firstName || !lastName || !dob || !legalSex) {
        alert('Please fill in all required fields.');
        return;
    }

    const newMember = {
        id: householdMemberId || Date.now().toString(), // Generate a unique ID if not provided
        prefix,
        firstName,
        middleInitial,
        lastName,
        suffix,
        dob,
        legalSex,
    };

    const clientId = getQueryParam('id');
    if (!clientId) {
        console.error('Client ID not found in query parameters.');
        return;
    }

    try {
        // Update the household member in the backend
        const response = await fetch(`/update-household-member`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ clientId, householdMember: newMember }),
        });

        if (!response.ok) {
            throw new Error('Failed to save household member.');
        }

        // Reload the household members list
        loadHouseholdMembers();
        closeHouseholdMemberModal();
    } catch (error) {
        console.error('Error saving household member:', error);
    }
}

// Populate the Best Contact Phone Number dropdown
function populateBestContactDropdown() {
    const dropdown = document.getElementById('bestContactNumber');
    const currentSelection = dropdown.value; // Save the currently selected contactId
    dropdown.innerHTML = '<option value="" disabled>Select Best Contact</option>'; // Reset options

    if (client && client.Contacts && client.Contacts.length > 0) {
        console.log('Contacts:', client.Contacts); // Debugging log
        client.Contacts.forEach((contact) => {
            const option = document.createElement('option');
            option.value = contact.contactId; // Use contactId as the value
            option.textContent = `${contact.firstName} ${contact.lastName} - ${formatPhoneNumber(contact.phoneNumber)}`; // Display name and phone number
            dropdown.appendChild(option);
        });

        // Restore the previously selected value if it exists
        if (currentSelection) {
            const selectedContact = client.Contacts.find(contact => contact.contactId === currentSelection);
            if (selectedContact) {
                dropdown.value = currentSelection; // Set the value directly
                console.log(`Dropdown value set to: ${currentSelection}`);
            } else {
                dropdown.value = ''; // Default to no selection
                console.warn('No matching contactId found in client data.');
            }
        } else if (client.bestContactNumber) {
            const selectedContact = client.Contacts.find(contact => contact.contactId === client.bestContactNumber);
            if (selectedContact) {
                dropdown.value = client.bestContactNumber; // Set the value directly
                console.log(`Dropdown value set to: ${client.bestContactNumber}`);
            } else {
                dropdown.value = ''; // Default to no selection
                console.warn('No matching contactId found in client data.');
            }
        } else {
            dropdown.value = ''; // Default to no selection
            console.warn('No best contact number found in client data.');
        }
    } else {
        console.warn('No contacts available or client data is missing.');
        dropdown.innerHTML = '<option value="" disabled selected>No Contacts Available</option>';
    }
}

// Function to update the backend with the best contact value
function updateBestContactInBackend(value) {
    const clientId = getQueryParam('id');
    if (!clientId) {
        console.error('Client ID not found in query parameters.');
        return;
    }

    const requestBody = {
        clientId,
        clientData: { bestContactNumber: value }, // Save the contactId
    };

    fetch(`/update-client`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody),
    })
        .then((response) => {
            if (response.ok) {
                console.log(`Best contact updated to contactId: ${value}`);
            } else {
                return response.json().then((error) => {
                    console.error('Error details:', error);
                    throw new Error(`Failed to update best contact: ${error.message}`);
                });
            }
        })
        .catch((error) => console.error('Error updating best contact:', error));
}

// Save the selected Best Contact Phone Number
function saveBestContactNumber() {
    const dropdown = document.getElementById('bestContactNumber');
    const selectedOption = dropdown.options[dropdown.selectedIndex];

    if (!selectedOption || !selectedOption.value) {
        alert('Please select a contact.');
        return;
    }

    const selectedContactId = selectedOption.value; // Use contactId as the value
    const clientId = getQueryParam('id'); // Get the client ID from the URL

    if (!clientId) {
        console.error('Client ID not found in query parameters.');
        return;
    }

    const requestBody = {
        clientId,
        clientData: { bestContactNumber: selectedContactId }, // Save the contactId
    };

    // Make a backend call to save the best contact number
    fetch('/update-client', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody),
    })
        .then((response) => {
            if (response.ok) {
                console.log(`Best contact number updated to contactId: ${selectedContactId}`);
            } else {
                return response.json().then((error) => {
                    console.error('Error details:', error);
                    throw new Error(`Failed to update best contact number: ${error.message}`);
                });
            }
        })
        .catch((error) => {
            console.error('Error updating best contact number:', error);
        });
}

// Ensure the dropdown is populated on page load
document.addEventListener('DOMContentLoaded', () => {
    populateBestContactDropdown();
});

// Redirect to the household view
function redirectToHouseholdView() {
    const clientId = getQueryParam('id');
    if (!clientId) {
        console.error('Client ID not found in query parameters.');
        return;
    }

    const userConfirmed = confirm('Are you sure you want to save and release the profile?');
    if (userConfirmed) {
        const requestBody = {
            clientId,
            clientData: { screeningInProgress: false },
        };

        fetch(`/update-client`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody),
        })
            .then((response) => {
                if (!response.ok) {
                    return response.json().then((error) => {
                        if (error.message !== 'No changes were made to the client data.') {
                            throw new Error(`Failed to update client data: ${error.message}`);
                        }
                    });
                }
            })
            .catch((error) => console.error('Error updating client data:', error))
            .finally(() => {
                window.location.href = `householdview.html?id=${clientId}`;
            });
    }
}

let editingContactIndex = null; // Track the index of the contact being edited

// Render contacts dynamically
function renderContacts() {
    const contactsContainer = document.getElementById('contacts-list');
    contactsContainer.innerHTML = ''; // Clear existing contacts

    // Ensure client.Contacts exists
    if (!client || !client.Contacts || client.Contacts.length === 0) {
        contactsContainer.innerHTML = '<p>No contacts available.</p>';
        return;
    }

    client.Contacts.forEach((contact, index) => {
        const contactDiv = document.createElement('div');
        contactDiv.classList.add('left-sidebar');
        contactDiv.innerHTML = `
            <p><strong>Name:</strong><br> ${contact.firstName?.toUpperCase() || 'N/A'} ${contact.lastName?.toUpperCase() || 'N/A'}</p>
            <p><strong>Phone:</strong><br> ${formatPhoneNumber(contact.phoneNumber) || 'N/A'}</p>
            <p><strong>Authorized Representative:</strong><br> ${contact.authorizedRepresentative?.toUpperCase() || 'N/A'}</p>
            <button onclick="openContactModalByIndex(${index})">Edit Contact</button>
        `;
        contactsContainer.appendChild(contactDiv);
    });
}

// Open the modal for adding or editing a contact
function openContactModal(contact = null, index = null) {
    const modal = document.getElementById('contactModal');
    const modalTitle = document.getElementById('modal-title');
    const firstNameInput = document.getElementById('contactFirstName');
    const lastNameInput = document.getElementById('contactLastName');
    const phoneNumberInput = document.getElementById('contactPhoneNumber');
    const authorizedRepSelect = document.getElementById('authorizedRepresentative');
    const buttonContainer = modal.querySelector('.button-container');

    // Clear existing buttons to avoid duplicates
    buttonContainer.innerHTML = `
        <button type="button" onclick="saveContact()">Save</button>
        <button type="button" onclick="closeContactModal()">Cancel</button>
    `;

    if (contact) {
        // Populate fields for editing
        modalTitle.textContent = 'Edit Contact';
        firstNameInput.value = contact.firstName || '';
        lastNameInput.value = contact.lastName || '';
        phoneNumberInput.value = contact.phoneNumber || '';
        authorizedRepSelect.value = contact.authorizedRepresentative || 'N/A';
        editingContactIndex = index;

        // Add a "Delete" button for editing
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete';
        deleteButton.type = 'button';
        deleteButton.style.backgroundColor = 'red';
        deleteButton.onmouseover = () => deleteButton.style.backgroundColor = 'darkred';
        deleteButton.onmouseout = () => deleteButton.style.backgroundColor = 'red';
        deleteButton.style.color = 'white';
        deleteButton.onclick = () => deleteContact(index);
        buttonContainer.appendChild(deleteButton);
    } else {
        // Clear fields for adding
        modalTitle.textContent = 'Add Contact';
        firstNameInput.value = '';
        lastNameInput.value = '';
        phoneNumberInput.value = '';
        authorizedRepSelect.value = 'N/A';
        editingContactIndex = null;
    }

    modal.style.display = 'block';
}

// Save the contact (add or edit)
async function saveContact() {
    const firstName = document.getElementById('contactFirstName').value.trim();
    const lastName = document.getElementById('contactLastName').value.trim();
    const phoneNumber = document.getElementById('contactPhoneNumber').value.trim();
    const authorizedRepresentative = document.getElementById('authorizedRepresentative').value;
    const clientId = getQueryParam('id'); // Ensure clientId is retrieved from the URL

    // Validate required fields
    if (!clientId || !firstName || !lastName || !phoneNumber) {
        alert('Please fill in all required fields.');
        console.error('Missing required fields:', { clientId, firstName, lastName, phoneNumber });
        return;
    }

    // Generate a unique contactId for new contacts
    const generateContactId = () => `contact-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    const newContact = {
        firstName,
        lastName,
        phoneNumber,
        authorizedRepresentative,
        contactId: editingContactIndex !== null ? client.Contacts[editingContactIndex].contactId : generateContactId(), // Reuse existing contactId if editing
    };

    // Ensure the Contacts array exists locally
    if (!client.Contacts) {
        client.Contacts = []; // Initialize the Contacts array if it doesn't exist
    }

    try {
        let response;
        if (editingContactIndex !== null) {
            // Edit existing contact
            client.Contacts[editingContactIndex] = newContact;

            // Send update request to the backend
            response = await fetch('/add-to-contacts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    clientId, // Pass the client ID
                    contact: newContact, // Pass the updated contact
                    index: editingContactIndex, // Pass the index of the contact to update
                }),
            });
        } else {
            // Add new contact
            client.Contacts.push(newContact);

            // Send add request to the backend
            response = await fetch('/add-to-contacts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    clientId, // Pass the client ID
                    contact: newContact, // Pass the new contact
                }),
            });
        }

        const result = await response.json();
        if (response.ok && result.success) {
            console.log('Contact saved successfully:', result.message);
        } else {
            console.error('Failed to save contact:', result.message);
            alert(`Error: ${result.message}`);
        }
    } catch (error) {
        console.error('Error while saving contact to the database:', error);
        alert('An error occurred while saving the contact. Please try again.');
    }

    // Re-render contacts and dropdown, then close modal
    renderContacts();
    populateBestContactDropdown(); // Re-render the dropdown
    closeContactModal();
}

// Delete a contact
async function deleteContact(index) {
    if (!confirm('Are you sure you want to delete this contact?')) {
        return; // Exit if the user cancels
    }

    try {
        // Remove the contact locally
        const deletedContact = client.Contacts.splice(index, 1)[0];

        // Send delete request to the backend
        const response = await fetch('/add-to-contacts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                clientId: client.id, // Pass the client ID
                contact: deletedContact, // Pass the deleted contact
                index, // Pass the index of the contact to delete
                delete: true, // Indicate this is a delete operation
            }),
        });

        const result = await response.json();
        if (result.success) {
            console.log('Contact deleted successfully:', result.message);
        } else {
            console.error('Failed to delete contact:', result.message);
            alert(`Error: ${result.message}`);
        }
    } catch (error) {
        console.error('Error while deleting contact from the database:', error);
        alert('An error occurred while deleting the contact. Please try again.');
    }

    // Re-render contacts and dropdown
    renderContacts();
    populateBestContactDropdown(); // Re-render the dropdown
    closeContactModal();
}

// Close the modal
function closeContactModal() {
    const modal = document.getElementById('contactModal');
    modal.style.display = 'none';
}

// Close the modal when clicking outside of it
window.addEventListener('click', (event) => {
    const modal = document.getElementById('contactModal');
    const modalContent = modal.querySelector('.modal-content');
    if (event.target === modal && !modalContent.contains(event.target)) {
        closeContactModal();
    }
});


// Open the modal for editing a contact by index
function openContactModalByIndex(index) {
    const contact = client.Contacts[index]; // Get the contact by index
    openContactModal(contact, index); // Call the existing openContactModal function
}

// Utility function to format phone numbers
function formatPhoneNumber(phone) {
    if (!phone) return '';
    const cleaned = phone.replace(/\D/g, ''); // Remove all non-numeric characters
    const match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/); // Match the phone number pattern
    return match ? `(${match[1]})-${match[2]}-${match[3]}` : phone; // Format if valid, else return original
}

function formatPhoneNumber(phone) {
    if (!phone) return '';
    const cleaned = phone.replace(/\D/g, ''); // Remove all non-numeric characters
    const match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/); // Match the phone number pattern
    return match ? `(${match[1]})-${match[2]}-${match[3]}` : phone; // Format if valid, else return original
}

function getQueryParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// Declare client as a global variable
let client = null;

// Ensure the script runs after the DOM is fully loaded
document.addEventListener('DOMContentLoaded', async () => {
    const clientId = getQueryParam('id'); // Get the client ID from the URL

    try {
        const response = await fetch(`/get-client/${clientId}`);
        if (!response.ok) {
            throw new Error(`Failed to fetch client data: ${response.statusText}`);
        }

        // Assign the fetched client data to the global client variable
        client = await response.json();

        // Populate the form fields and render contacts
        populateFormFields(client);
        renderContacts();
        populateBestContactDropdown();
    } catch (error) {
        console.error('Error loading client data:', error);
    }
});

// Initialize the page
document.addEventListener('DOMContentLoaded', () => {
    loadClientData();
    addFieldListeners();
    renderContacts();
});
    </script>

<script src="editnavigation.js"></script>
<script src="applying.js"></script>
    <script src="applicant.js"></script>
    <script src="notes.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
    let zipToCountyMap = {}; // Global object to store ZIP-to-county mappings

    // Load and parse the CSV file
    function loadZipCountyData() {
        Papa.parse('./uszips.csv', {
            download: true,
            header: true,
            complete: function (results) {
                results.data.forEach(row => {
                    const zip = row.zip;
                    const counties = row.county_names_all; // Use the county_names_all column
                    if (zip && counties) {
                        if (!zipToCountyMap[zip]) {
                            zipToCountyMap[zip] = [];
                        }
                        // Split counties by "|" and add them to the map
                        counties.split('|').forEach(county => {
                            if (!zipToCountyMap[zip].includes(county.trim())) {
                                zipToCountyMap[zip].push(county.trim());
                            }
                        });
                    }
                });
                console.log('Zip-to-county data loaded:', zipToCountyMap);

                // Filter the county dropdown on page load
                filterCountyDropdownOnPageLoad();
            },
            error: function (error) {
                console.error('Error loading CSV file:', error);
            }
        });
    }

    // Filter the county dropdown based on the ZIP code on page load
    function filterCountyDropdownOnPageLoad() {
        const zipCodeInput = document.getElementById("zipCode");
        const countyDropdown = document.getElementById("county");
        const zipCode = zipCodeInput.value.trim();

        if (zipCode.length === 5 && zipToCountyMap[zipCode]) {
            // Populate the county dropdown based on the ZIP code
            const backendCounty = countyDropdown.value; // Preserve the preexisting county value
            updateCountyDropdown(zipToCountyMap[zipCode], backendCounty);
        } else {
            // If the ZIP code is invalid or blank, do not overwrite the dropdown
            console.log("Invalid or empty ZIP code on page load. Preserving existing county selection.");
        }
    }

// Update the county dropdown based on the ZIP code
function updateCountyDropdown(counties, backendCounty = null) {
    const countyDropdown = document.getElementById("county");

    // Clear existing options
    countyDropdown.innerHTML = '<option value="" disabled>Select County</option>';

    counties.forEach(county => {
        const option = document.createElement("option");
        option.value = county;
        option.textContent = county;
        countyDropdown.appendChild(option);
    });

    // Auto-select logic
    if (backendCounty && counties.includes(backendCounty)) {
        // If a backend county exists and matches one of the counties, select it
        countyDropdown.value = backendCounty;
    } else if (counties.length === 1) {
        // If there's only one county, auto-select it
        countyDropdown.value = counties[0];

        // Dispatch a change event to trigger the school district population
        const event = new Event('change', { bubbles: true });
        countyDropdown.dispatchEvent(event);
    } else {
        // Otherwise, leave the dropdown unselected
        countyDropdown.value = "";
    }
}

    // Add event listener for the ZIP code input
    function setupZipCodeListener() {
        const zipCodeInput = document.getElementById("zipCode");
        const countyDropdown = document.getElementById("county");

        zipCodeInput.addEventListener("blur", async function () {
            const zipCode = this.value.trim();

            if (zipCode.length === 5 && zipToCountyMap[zipCode]) {
                // Populate the county dropdown based on the ZIP code
                updateCountyDropdown(zipToCountyMap[zipCode]);
            } else {
                // Reset the dropdown to "Select County" if the ZIP code is invalid, null, or blank
                countyDropdown.innerHTML = '<option value="" disabled selected>Select County</option>';
                console.log("Invalid, null, or empty ZIP code entered. Defaulting to 'Select County'.");

                // Set the county data to null in the backend
                await updateClientData('county', null);
            }
        });
    }

    // Add event listener for the county dropdown
    document.getElementById("county").addEventListener("change", function () {
        const selectedValue = this.value;

        if (selectedValue === "") {
            // If "Select County" is selected, set county to null in the database
            updateClientData('county', null);
        }
    });

    // Function to update client data in the backend
    async function updateClientData(field, value) {
        const clientId = getQueryParam('id'); // Get the client ID from the URL

        if (!clientId) {
            console.error('Client ID not found in query parameters.');
            return;
        }

        const requestBody = {
            clientId,
            clientData: { [field]: value },
        };

        try {
            const response = await fetch('/update-client', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
                const error = await response.json();
                console.error(`Failed to update ${field}:`, error.message);
            } else {
                console.log(`Successfully updated ${field} to ${value}`);
            }
        } catch (error) {
            console.error(`Error updating ${field}:`, error);
        }
    }

    // Utility function to get query parameters
    function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
        loadZipCountyData(); // Load the CSV data
        setupZipCodeListener(); // Set up the ZIP code input listener
    });
</script>

</body>
</html>