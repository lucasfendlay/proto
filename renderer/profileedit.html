<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Client Profile</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="notes.css">

    <style>
        body {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 60px;
        }

        details > summary {
            cursor: pointer;
        }

        #interactionList {
            list-style-type: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 90%;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        #interactionList li {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 90%;
        }

        #interactionList li div {
            flex: 1;
            margin-right: 10px;
            word-wrap: break-word;
            font-size: 0.85rem;
        }

        #interactionList li div:last-child {
            margin-right: 0;
        }

        #interactionList li strong {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .button-container, .button-container1 {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .button-container button, .button-container1 button {
            flex: 1;
            padding: 10px 15px;
        }

        .form-field {
            margin-bottom: 10px;
        }

        .selection-box {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 8px;
        }

        .selection-box div {
            padding: 8px 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f5f5f5;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            width: 100px;
            box-sizing: border-box;
        }

        .selection-box div:hover {
            background-color: #eaeaea;
            border-color: #999;
        }

        .selection-box div.selected {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
        }

        #terminate-button {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        #terminate-button:hover {
            background-color: #cc0000;
        }

        #terminate-button:disabled {
            background-color: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
        }

                /* Button container styling */
                .button-container {
            display: flex;
            justify-content: center; /* Center the button horizontally */
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
    
        .button-container button {
    flex: 1;
    padding: 10px 15px !important; /* Override global padding */
    font-size: 1rem;
    cursor: pointer;
    border: none; /* Remove global border */
    margin: 0; /* Remove global margin */
}

        /* Selection box styling */
        .selection-box div.selected {
            background-color: #007bff;
            color: white;
            border: 1px solid #0056b3;
            border-radius: 5px;
            padding: 5px;
        }
    
        /* Sidebar header styling */
.sidebar-header {
            display: fixed;
            justify-items: center; /* Center content horizontally */
            text-align: center; /* Center text */
            margin-bottom: 20px; /* Add spacing below the header */
            width: 300px; /* Match the width of .left-sidebar */
            margin: 0 auto; /* Center the header horizontally */
        }

        .sidebar-header .button-container {
            display: flex;
            justify-content: center; /* Center the button horizontally */
            width: 100%; /* Ensure the button container spans the full width */
        }
    
        /* Contacts list container */
        #contacts-list {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Adds spacing between items */
            width: 300px; /* Match the width of .left-sidebar */
            margin: 0 auto; /* Center the header horizontally */
            max-height: 1000px; /* Match the height of householdedit containers */
            overflow-y: auto; /* Add scroll if content overflows */
            background-color: #f4f4f4; /* Light gray background */
            border: 1px solid #ddd; /* Border around the container */
            border-radius: 8px; /* Rounded corners */
            padding: 15px; /* Padding inside the container */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
        }
    
        /* Individual sidebar items */
        .left-sidebar {
            background-color: #fff; /* White background for each item */
            border: 1px solid #ccc; /* Border around each item */
            border-radius: 5px; /* Rounded corners for each item */
            padding: 10px; /* Padding inside each item */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* Subtle shadow for each item */
            margin: 0 auto; /* Center the sidebar items horizontally */
            width: 280px; /* Adjust width as needed */
            transform: translateX(-8px); /* Shift the sidebar 10px to the left */

        }
    
    
        .left-sidebar strong {
            font-weight: bold; /* Bold labels */
        }

                /* Modal styling */
                .modal {
    display: none;
    position: fixed; /* Position relative to the viewport */
    top: 0;
    left: 0;
    width: 100vw; /* Full viewport width */
    height: 100vh; /* Full viewport height */
    background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
    z-index: 1000; /* Ensure it appears above other elements */
    display: flex; /* Use flexbox for centering */
    justify-content: center; /* Center horizontally */
    align-items: center; /* Center vertically */
    overflow: hidden; /* Prevent scrolling */
}

.modal-content {
    background-color: transparent;
    border-radius: px;
    width: 90%; /* Adjust width for responsiveness */
    max-width: 500px; /* Limit the modal width */
    padding: 0px;
    position: absolute; /* Position relative to the modal container */
    top: 50%; /* Center vertically */
    left: 46.8%; /* Center horizontally */
    transform: translate(-50%, -50%); /* Adjust for the modal's own dimensions */
    text-align: left;
}    

.error {
        border: 2px solid red;
        background-color: #ffe6e6; /* Light red background */
    }

</style>

    <script src="editnavigation.js"></script>
    <script src="userInfo.js"></script>

</head>
<body>    <div id="notes-container">
        <textarea id="note-input" placeholder="Add Note..."></textarea>
        <button id="save-note">Save Note</button>
        <div id="notes-list">
            </div>
            </div>

                <!-- Add this container where you want the contacts to appear -->
    <div class="left-sidebar-container" id="contactsSidebarContainer">
        <div class="sidebar-header">
            <h2>Contacts</h2>
            <div class="button-container">
                <button id="add-contact-button" onclick="openContactModal()">Add New Contact</button>
            </div>
        </div>
        <div id="contacts-list" class="left-sidebar"></div>
    </div>

<!-- Modal for Adding/Editing Contacts -->
<div id="contactModal" class="contactmodal" style="display: none;">
    <div class="modal-content">
        <form id="contactForm">
            <h2 id="modal-title">Add Contact</h2>
            <label for="contactFirstName">First Name:</label>
            <input type="text" id="contactFirstName" required>

            <label for="contactLastName">Last Name:</label>
            <input type="text" id="contactLastName" required>

            <label for="contactPhoneNumber">Phone Number:</label>
            <input type="text" id="contactPhoneNumber" required>

            <label for="authorizedRepresentative">Authorized Representative:</label>
            <select id="authorizedRepresentative">
                <option value="N/A" selected>N/A</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </select>

            <div class="button-container">
                <button type="button" onclick="saveContact()">Save</button>
                <button type="button" onclick="closeContactModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

    <h2 id="profileId">Profile: Loading...</h2> <!-- New header for Profile ID -->
    <p id="terminationStatus" style="color: red; display: none;"><strong>PROFILE TERMINATED</strong></p> <!-- Termination status -->



    <div class="left-sidebar-container" id="leftSidebarContainer" style="display: none;">
        <div id="snap-household-container" class="left-sidebar"></div>
        <div id="liheap-household-container" class="left-sidebar"></div>
        <div id="household-members-container" class="left-sidebar"></div>
</div>

    <form id="clientForm">
        <h2>Primary Client</h2>
        <div class="form-field">
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" name="firstName">
        </div>
        <div class="form-field">
            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" name="lastName">
        </div>
        <div class="form-field">
            <label for="phoneNumber">Phone Number:</label>
            <input type="text" id="phoneNumber" name="phoneNumber">
        </div>

        <div class="form-field">
            <label>Are you currently experiencing homelessness?</label>
            <div class="selection-box">
                <div data-value="homelessnessyes" onclick="updateHomelessness('yes')">Yes</div>
                <div data-value="homelessnessno" onclick="updateHomelessness('no')">No</div>
            </div>
        </div>
        
        <div class="form-field">
            <label for="streetAddress">Street Address:</label>
            <input type="text" id="streetAddress" name="streetAddress">
        </div>
        <div class="form-field">
            <label for="streetAddress2">Address Line 2:</label>
            <input type="text" id="streetAddress2" name="streetAddress2">
        </div>
        <div class="form-field">
            <label for="city">City:</label>
            <input type="text" id="city" name="city">
        </div>
        <div class="form-field">
            <label for="state">State:</label>
            <select id="state" name="state">
                <option value="PA" selected>PA</option>
                <option value="AL">AL</option>
                <option value="AK">AK</option>
                <option value="AZ">AZ</option>
                <option value="AR">AR</option>
                <option value="CA">CA</option>
                <option value="CO">CO</option>
                <option value="CT">CT</option>
                <option value="DE">DE</option>
                <option value="FL">FL</option>
                <option value="GA">GA</option>
                <option value="HI">HI</option>
                <option value="ID">ID</option>
                <option value="IL">IL</option>
                <option value="IN">IN</option>
                <option value="IA">IA</option>
                <option value="KS">KS</option>
                <option value="KY">KY</option>
                <option value="LA">LA</option>
                <option value="ME">ME</option>
                <option value="MD">MD</option>
                <option value="MA">MA</option>
                <option value="MI">MI</option>
                <option value="MN">MN</option>
                <option value="MS">MS</option>
                <option value="MO">MO</option>
                <option value="MT">MT</option>
                <option value="NE">NE</option>
                <option value="NV">NV</option>
                <option value="NH">NH</option>
                <option value="NJ">NJ</option>
                <option value="NM">NM</option>
                <option value="NY">NY</option>
                <option value="NC">NC</option>
                <option value="ND">ND</option>
                <option value="OH">OH</option>
                <option value="OK">OK</option>
                <option value="OR">OR</option>
                <option value="RI">RI</option>
                <option value="SC">SC</option>
                <option value="SD">SD</option>
                <option value="TN">TN</option>
                <option value="TX">TX</option>
                <option value="UT">UT</option>
                <option value="VT">VT</option>
                <option value="VA">VA</option>
                <option value="WA">WA</option>
                <option value="WV">WV</option>
                <option value="WI">WI</option>
                <option value="WY">WY</option>
                <option value="DC">DC</option>
                <option value="PR">Puerto Rico</option>
                <option value="GU">Guam</option>
                <!-- Add other states as needed -->
            </select>
        </div>
        <div class="form-field">
            <label for="zipCode">Zip Code:</label>
            <input type="text" id="zipCode" name="zipCode">
        </div>
        <div class="form-field">
            <label for="county">County:</label>
            <select id="county" name="county">
                <option value="" disabled selected>Select County</option>
                <option value="Adams">Adams</option>
                <option value="Allegheny">Allegheny</option>
                <option value="Armstrong">Armstrong</option>
                <option value="Beaver">Beaver</option>
                <option value="Bedford">Bedford</option>
                <option value="Berks">Berks</option>
                <option value="Blair">Blair</option>
                <option value="Bradford">Bradford</option>
                <option value="Bucks">Bucks</option>
                <option value="Butler">Butler</option>
                <option value="Cambria">Cambria</option>
                <option value="Cameron">Cameron</option>
                <option value="Carbon">Carbon</option>
                <option value="Centre">Centre</option>
                <option value="Chester">Chester</option>
                <option value="Clarion">Clarion</option>
                <option value="Clearfield">Clearfield</option>
                <option value="Clinton">Clinton</option>
                <option value="Columbia">Columbia</option>
                <option value="Crawford">Crawford</option>
                <option value="Cumberland">Cumberland</option>
                <option value="Dauphin">Dauphin</option>
                <option value="Delaware">Delaware</option>
                <option value="Elk">Elk</option>
                <option value="Erie">Erie</option>
                <option value="Fayette">Fayette</option>
                <option value="Forest">Forest</option>
                <option value="Franklin">Franklin</option>
                <option value="Fulton">Fulton</option>
                <option value="Greene">Greene</option>
                <option value="Huntingdon">Huntingdon</option>
                <option value="Indiana">Indiana</option>
                <option value="Jefferson">Jefferson</option>
                <option value="Juniata">Juniata</option>
                <option value="Lackawanna">Lackawanna</option>
                <option value="Lancaster">Lancaster</option>
                <option value="Lawrence">Lawrence</option>
                <option value="Lebanon">Lebanon</option>
                <option value="Lehigh">Lehigh</option>
                <option value="Luzerne">Luzerne</option>
                <option value="Lycoming">Lycoming</option>
                <option value="McKean">McKean</option>
                <option value="Monroe">Monroe</option>
                <option value="Montgomery">Montgomery</option>
                <option value="Montour">Montour</option>
                <option value="Northampton">Northampton</option>
                <option value="Northumberland">Northumberland</option>
                <option value="Perry">Perry</option>
                <option value="Philadelphia">Philadelphia</option>
                <option value="Pike">Pike</option>
                <option value="Potter">Potter</option>
                <option value="Schuylkill">Schuylkill</option>
                <option value="Snyder">Snyder</option>
                <option value="Somerset">Somerset</option>
                <option value="Sullivan">Sullivan</option>
                <option value="Susquehanna">Susquehanna</option>
                <option value="Tioga">Tioga</option>
                <option value="Union">Union</option>
                <option value="Venango">Venango</option>
                <option value="Warren">Warren</option>
                <option value="Washington">Washington</option>
                <option value="Wayne">Wayne</option>
                <option value="Westmoreland">Westmoreland</option>
                <option value="Wyoming">Wyoming</option>
                <option value="York">York</option>
                <!-- Add other counties as needed -->
            </select>
        </div>
        <div class="form-field">
            <label for="speakingLanguage">Preferred Speaking Language:</label>
            <select id="speakingLanguage" name="speakingLanguage">
                <option value="" disabled selected>Select Language</option>
                <option value="English">English</option>
                <option value="Arabic">Arabic</option>
<option value="Bengali">Bengali</option>
<option value="Bulgarian">Bulgarian</option>
<option value="Croatian">Croatian</option>
<option value="Czech">Czech</option>
<option value="Danish">Danish</option>
<option value="Dutch">Dutch</option>
<option value="Estonian">Estonian</option>
<option value="Finnish">Finnish</option>
<option value="French">French</option>
<option value="German">German</option>
<option value="Greek">Greek</option>
<option value="Hebrew">Hebrew</option>
<option value="Hindi">Hindi</option>
<option value="Hungarian">Hungarian</option>
<option value="Icelandic">Icelandic</option>
<option value="Irish">Irish</option>
<option value="Italian">Italian</option>
<option value="Japanese">Japanese</option>
<option value="Korean">Korean</option>
<option value="Latvian">Latvian</option>
<option value="Lithuanian">Lithuanian</option>
<option value="Maltese">Maltese</option>
<option value="Mandarin">Mandarin</option>
<option value="Norwegian">Norwegian</option>
<option value="Persian">Persian</option>
<option value="Portuguese">Portuguese</option>
<option value="Punjabi">Punjabi</option>
<option value="Romanian">Romanian</option>
<option value="Russian">Russian</option>
<option value="Serbian">Serbian</option>
<option value="Slovak">Slovak</option>
<option value="Slovenian">Slovenian</option>
<option value="Spanish">Spanish</option>
<option value="Swahili">Swahili</option>
<option value="Swedish">Swedish</option>
<option value="Tagalog">Tagalog</option>
<option value="Thai">Thai</option>
<option value="Turkish">Turkish</option>
<option value="Urdu">Urdu</option>
<option value="Vietnamese">Vietnamese</option>
<option value="Welsh">Welsh</option>
                <!-- Add other languages as needed -->
            </select>
        </div>
        <div class="form-field">
            <label>Interpreter Used:</label>
            <div class="selection-box">
                <div data-value="interpreteryes" onclick="updateInterpreter('yes')">Yes</div>
                <div data-value="interpreterno" onclick="updateInterpreter('no')">No</div>
            </div>
        </div>
    </form>

    <button id="call-logging-button" class="interactive" onclick="confirmAndRedirect()">Start Screening</button>
    <button id="save-button" class="interactive" onclick="confirmSaveAndRelease(); window.saveAndReleaseProfile();">Save and Release Profile</button>
    <h2>Interaction Tracker</h2>
    <ul id="interactionList">
        <li>Loading...</li>
    </ul>
    
    <button id="terminate-button" class="interactive" onclick="confirmAndTerminate()">Terminate Profile</button>

    <script>
        // Function to get query parameter by name
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        async function confirmSaveAndRelease() {
        if (confirm("Are you sure you want to save and release this profile?")) {
            const clientId = getQueryParam('id'); // Retrieve the client ID from the URL
            const noteContent = "Profile released.";
            const timestamp = new Date().toLocaleString();
            const activeUser = sessionStorage.getItem('loggedInUser'); // Retrieve the active user

            if (!activeUser) {
                console.error("No active user found in sessionStorage.");
                return;
            }

            try {
                            // Set checkedOut to false
            await setCheckedOutStatus(clientId, false);

                // Save client data
                await saveClient();

                // Add a note about the action
                const note = {
                    text: noteContent,
                    timestamp: timestamp,
                    username: activeUser
                };

                try {
    const response = await fetch('/add-note-to-client', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ clientId, note }),
    });

    const result = await response.json();
    if (!response.ok || !result.success) {
        console.error('Failed to add note to client:', result.message);
        alert('Failed to add note to client.');
    } else {
        console.log('Note successfully added to client.');
    }
} catch (error) {
    console.error('Error adding note to client:', error);
    alert('An error occurred while adding the note.');
}
                // Call the releaseProfile function to update screeningInProgress to false
                await releaseProfile();

                // Redirect to profile view
                GoToProfileView();
            } catch (error) {
                console.error("Error during confirmSaveAndRelease:", error);
            }
        }
    }

    let client = {}; // Global variable to hold client data

// Function to load client data and populate the form
async function loadClientData() {
    const clientId = getQueryParam('id');
    console.log(`Loading client data for ID: ${clientId}`);
    try {
        const response = await fetch(`/get-client/${clientId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        });

        if (!response.ok) {
            throw new Error(`Failed to fetch client: ${response.statusText}`);
        }

        client = await response.json(); // Assign the fetched client data to the global variable
        if (client) {
            console.log('Client data loaded:', client);

            // Populate form fields with client data
            document.getElementById('zipCode').value = client.zipCode || ''; // Populate zip code
            const countyDropdown = document.getElementById('county');
            const backendZipCode = client.zipCode || '';
            const backendCounty = client.county || null;

            // Populate the county dropdown based on the zip code
            if (backendZipCode.length === 5 && zipToCountyMap[backendZipCode]) {
                updateCountyDropdown(zipToCountyMap[backendZipCode], backendCounty);
            } else {
                // If the zip code is invalid or blank, reset the dropdown to "Select County"
                countyDropdown.innerHTML = '<option value="" disabled selected>Select County</option>';
                console.log("Invalid, null, or empty zip code. Defaulting to 'Select County'.");
            }

            // Hide the "Start Screening" button if a screening is in progress
            const startScreeningButton = document.getElementById('call-logging-button');
            startScreeningButton.style.display = client.screeningInProgress ? 'none' : 'block';

            // Populate the Profile ID in the header
            document.getElementById('profileId').textContent = `Profile: ${client.id || 'N/A'}`;

            // Display "Terminated" status if applicable
            const terminationStatus = document.getElementById('terminationStatus');
            const terminateButton = document.getElementById('terminate-button');
            if (client.terminated) {
                terminationStatus.style.display = 'block';
                terminateButton.style.display = 'none';
            } else {
                terminationStatus.style.display = 'none';
                terminateButton.style.display = 'inline-block';
            }

            // Populate other form fields with client data
            document.getElementById('firstName').value = (client.firstName || '').toUpperCase();
            document.getElementById('lastName').value = (client.lastName || '').toUpperCase();
            document.getElementById('phoneNumber').value = formatPhoneNumber(client.phoneNumber || '');
            document.getElementById('streetAddress').value = (client.streetAddress || '').toUpperCase();
            document.getElementById('streetAddress2').value = (client.streetAddress2 || '').toUpperCase();
            document.getElementById('city').value = (client.city || '').toUpperCase();
            document.getElementById('state').value = (client.state || 'PA').toUpperCase(); // Default to "PA"
            document.getElementById('speakingLanguage').value = client.speakingLanguage || '';

            // Highlight the selected homelessness button
            document.querySelectorAll('.selection-box div[data-value^="homelessness"]').forEach(div => div.classList.remove('selected'));
            const selectedHomelessness = document.querySelector(`.selection-box div[data-value="homelessness${client.homelessness}"]`);
            if (selectedHomelessness) {
                selectedHomelessness.classList.add('selected');
            }

            // Highlight the selected interpreter button
            document.querySelectorAll('.selection-box div[data-value^="interpreter"]').forEach(div => div.classList.remove('selected'));
            const selectedInterpreter = document.querySelector(`.selection-box div[data-value="interpreter${client.interpreter}"]`);
            if (selectedInterpreter) {
                selectedInterpreter.classList.add('selected');
            }

            // Populate interaction tracker
            const interactionList = document.getElementById('interactionList');
            interactionList.innerHTML = ''; // Clear existing entries

            if (client.callLogs && client.callLogs.length > 0) {
                // Sort call logs by timestamp in descending order
                client.callLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                client.callLogs.forEach(log => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div><strong>Agent:</strong> ${log.agent?.toUpperCase() || 'UNKNOWN AGENT'}</div>
                        <div><strong>Timestamp:</strong> ${log.timestamp?.toUpperCase() || 'UNKNOWN TIME'}</div>
                        <div><strong>Caller:</strong> ${(log.callerFirstName || '').toUpperCase()} ${(log.callerLastName || '').toUpperCase()}</div>
                        <div><strong>Phone:</strong> ${formatPhoneNumber(log.callerPhoneNumber) || ''}</div>
                        <div><strong>Direction:</strong> ${log.callDirection?.toUpperCase() || ''}</div>
                        <div><strong>Service Center:</strong> ${log.servicingCenter?.toUpperCase() || ''}</div>
                        <div><strong>Reason:</strong> ${log.reasonForCall?.toUpperCase() || ''}</div>
                        <div><strong>Referral:</strong> ${log.referralSource?.toUpperCase() || 'N/A'}</div>
                        ${log.specificReferral ? `<div><strong>Specifically:</strong> ${log.specificReferral.toUpperCase()}</div>` : ''}
                    `;
                    interactionList.appendChild(li);
                });
            } else {
                const noLogsMessage = document.createElement('li');
                noLogsMessage.textContent = 'No call logs available.';
                interactionList.appendChild(noLogsMessage);
            }

            // Render contacts
            console.log('Rendering contacts:', client.Contacts); // Debugging log
            renderContacts();
        } else {
            alert('Client not found.');
        }
    } catch (error) {
        console.error('Error loading client data:', error);
    }
}

let editingContactIndex = null; // Track the index of the contact being edited

// Render contacts dynamically
function renderContacts() {
    const contactsContainer = document.getElementById('contacts-list');
    contactsContainer.innerHTML = ''; // Clear existing contacts

    if (client.Contacts && client.Contacts.length > 0) {
        client.Contacts.forEach((contact, index) => {
            const contactDiv = document.createElement('div');
            contactDiv.classList.add('left-sidebar');
            contactDiv.innerHTML = `
                <p><strong>Name:</strong><br> ${contact.firstName?.toUpperCase() || 'N/A'} ${contact.lastName?.toUpperCase() || 'N/A'}</p>
                <p><strong>Phone:</strong><br> ${formatPhoneNumber(contact.phoneNumber) || 'N/A'}</p>
                <p><strong>Authorized Representative:</strong><br> ${contact.authorizedRepresentative?.toUpperCase() || 'N/A'}</p>
                <button onclick="openContactModalByIndex(${index})">Edit Contact</button>
            `;
            contactsContainer.appendChild(contactDiv);
        });
    } else {
        contactsContainer.innerHTML = '<p>No contacts available.</p>';
    }
}

// Open the modal for adding or editing a contact
function openContactModal(contact = null, index = null) {
    const modal = document.getElementById('contactModal');
    const modalTitle = document.getElementById('modal-title');
    const firstNameInput = document.getElementById('contactFirstName');
    const lastNameInput = document.getElementById('contactLastName');
    const phoneNumberInput = document.getElementById('contactPhoneNumber');
    const authorizedRepSelect = document.getElementById('authorizedRepresentative');
    const buttonContainer = modal.querySelector('.button-container');

    // Clear existing buttons to avoid duplicates
    buttonContainer.innerHTML = `
        <button type="button" onclick="saveContact()">Save</button>
        <button type="button" onclick="closeContactModal()">Cancel</button>
    `;

    if (contact) {
        // Populate fields for editing
        modalTitle.textContent = 'Edit Contact';
        firstNameInput.value = contact.firstName || '';
        lastNameInput.value = contact.lastName || '';
        phoneNumberInput.value = contact.phoneNumber || '';
        authorizedRepSelect.value = contact.authorizedRepresentative || 'N/A';
        editingContactIndex = index;

        // Add a "Delete" button for editing
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete';
        deleteButton.type = 'button';
        deleteButton.style.backgroundColor = 'red';
deleteButton.onmouseover = () => deleteButton.style.backgroundColor = 'darkred';
deleteButton.onmouseout = () => deleteButton.style.backgroundColor = 'red';
        deleteButton.style.color = 'white';
        deleteButton.onclick = () => deleteContact(index);
        buttonContainer.appendChild(deleteButton);
    } else {
        // Clear fields for adding
        modalTitle.textContent = 'Add Contact';
        firstNameInput.value = '';
        lastNameInput.value = '';
        phoneNumberInput.value = '';
        authorizedRepSelect.value = 'N/A';
        editingContactIndex = null;
    }

    modal.style.display = 'block';
}

// Save the contact (add or edit)
async function saveContact() {
    const firstName = document.getElementById('contactFirstName').value.trim();
    const lastName = document.getElementById('contactLastName').value.trim();
    const phoneNumber = document.getElementById('contactPhoneNumber').value.trim();
    const authorizedRepresentative = document.getElementById('authorizedRepresentative').value;
    const clientId = getQueryParam('id'); // Ensure clientId is retrieved from the URL

    // Validate required fields
    if (!clientId || !firstName || !lastName || !phoneNumber) {
        alert('Please fill in all required fields.');
        console.error('Missing required fields:', { clientId, firstName, lastName, phoneNumber });
        return;
    }

    const newContact = {
        firstName,
        lastName,
        phoneNumber,
        authorizedRepresentative,
    };

    // Ensure the Contacts array exists locally
    if (!client.Contacts) {
        client.Contacts = []; // Initialize the Contacts array if it doesn't exist
    }

    try {
        let response;
        if (editingContactIndex !== null) {
            // Edit existing contact
            client.Contacts[editingContactIndex] = newContact;

            // Send update request to the backend
            response = await fetch('/add-to-contacts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    clientId, // Pass the client ID
                    contact: newContact, // Pass the updated contact
                    index: editingContactIndex, // Pass the index of the contact to update
                }),
            });
        } else {
            // Add new contact
            client.Contacts.push(newContact);

            // Send add request to the backend
            response = await fetch('/add-to-contacts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    clientId, // Pass the client ID
                    contact: newContact, // Pass the new contact
                }),
            });
        }

        const result = await response.json();
        if (response.ok && result.success) {
            console.log('Contact saved successfully:', result.message);
        } else {
            console.error('Failed to save contact:', result.message);
            alert(`Error: ${result.message}`);
        }
    } catch (error) {
        console.error('Error while saving contact to the database:', error);
        alert('An error occurred while saving the contact. Please try again.');
    }

    // Re-render contacts and close modal
    renderContacts();
    closeContactModal();
}

// Delete a contact
async function deleteContact(index) {
    if (!confirm('Are you sure you want to delete this contact?')) {
        return; // Exit if the user cancels
    }

    try {
        // Remove the contact locally
        const deletedContact = client.Contacts.splice(index, 1)[0];

        // Send delete request to the backend
        const response = await fetch('/add-to-contacts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                clientId: client.id, // Pass the client ID
                contact: deletedContact, // Pass the deleted contact
                index, // Pass the index of the contact to delete
                delete: true, // Indicate this is a delete operation
            }),
        });

        const result = await response.json();
        if (result.success) {
            console.log('Contact deleted successfully:', result.message);
        } else {
            console.error('Failed to delete contact:', result.message);
            alert(`Error: ${result.message}`);
        }
    } catch (error) {
        console.error('Error while deleting contact from the database:', error);
        alert('An error occurred while deleting the contact. Please try again.');
    }

    // Re-render contacts and close modal
    renderContacts();
    closeContactModal();
}

// Close the modal
function closeContactModal() {
    const modal = document.getElementById('contactModal');
    modal.style.display = 'none';
}

// Close the modal when clicking outside of it
window.addEventListener('click', (event) => {
    const modal = document.getElementById('contactModal');
    const modalContent = modal.querySelector('.modal-content');
    if (event.target === modal && !modalContent.contains(event.target)) {
        closeContactModal();
    }
});


// Open the modal for editing a contact by index
function openContactModalByIndex(index) {
    const contact = client.Contacts[index]; // Get the contact by index
    openContactModal(contact, index); // Call the existing openContactModal function
}

// Utility function to format phone numbers
function formatPhoneNumber(phone) {
    if (!phone) return '';
    const cleaned = phone.replace(/\D/g, ''); // Remove all non-numeric characters
    const match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/); // Match the phone number pattern
    return match ? `(${match[1]})-${match[2]}-${match[3]}` : phone; // Format if valid, else return original
}

async function saveClient() {
    const clientId = getQueryParam('id');
    const clientData = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        phoneNumber: document.getElementById('phoneNumber').value,
        streetAddress: document.getElementById('streetAddress').value,
        streetAddress2: document.getElementById('streetAddress2').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        zipCode: document.getElementById('zipCode').value,
        county: document.getElementById('county').value,
        speakingLanguage: document.getElementById('speakingLanguage').value,
        interpreter: document.querySelector('.selection-box div.selected')?.dataset.value || 'N/A', // Default to "N/A"
    };

    try {
        const response = await fetch('/update-client', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ clientId, clientData }),
        });

        const result = await response.json();
        if (!response.ok || !result.success) {
            console.error('Failed to save client data:', result.message);
        } else {
            console.log('Client data successfully saved.');
        }
    } catch (error) {
        console.error('Error saving client data:', error);
        alert('An error occurred while saving client data.');
    }
}

function updateHomelessness(value) {
    // Clear selection for homelessness buttons only
    document.querySelectorAll('.selection-box div[data-value^="homelessness"]').forEach(div => div.classList.remove('selected'));
    const selectedButton = document.querySelector(`.selection-box div[data-value="homelessness${value}"]`);
    if (selectedButton) {
        selectedButton.classList.add('selected');
    }

    // Update the homelessness field in the client data
    updateClientData('homelessness', value);

    // Change the label for Street Address to Mailing Address if "Yes" is selected
    const streetAddressLabel = document.querySelector('label[for="streetAddress"]');
    if (value === 'yes') {
        streetAddressLabel.textContent = 'Mailing Address:';
    } else {
        streetAddressLabel.textContent = 'Street Address:';
    }
}

function updateInterpreter(value) {
    // Clear selection for interpreter buttons only
    document.querySelectorAll('.selection-box div[data-value^="interpreter"]').forEach(div => div.classList.remove('selected'));
    const selectedButton = document.querySelector(`.selection-box div[data-value="interpreter${value}"]`);
    if (selectedButton) {
        selectedButton.classList.add('selected');
    }

    // Update the interpreter field in the client data
    updateClientData('interpreter', value);
}

async function updateClientData(field, value) {
    const clientId = getQueryParam('id'); // Ensure clientId is retrieved from the URL

    // Validate required fields
    if (!clientId || !field) {
        console.error('Missing required fields for update:', { clientId, field, value });
        return;
    }

    // Prepare the data to be updated
    const clientData = { [field]: value };

    // If the zipCode is being updated, also include the county value
    if (field === 'zipCode') {
        const countyDropdown = document.getElementById('county');
        const selectedCounty = countyDropdown.value;
        clientData.county = selectedCounty || ''; // Include the county value (empty if none selected)
    }

    try {
        const response = await fetch('/update-client', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ clientId, clientData }),
        });

        const result = await response.json();
        if (response.ok && result.success) {
            console.log(`Client data successfully updated for ${field}.`);
        } else {
            console.error(`Failed to update client data for ${field}:`, result.message);
        }
    } catch (error) {
        console.error(`Error updating client data for ${field}:`, error);
        alert(`An error occurred while updating ${field}.`);
    }
}

// Add event listeners to text inputs
document.querySelectorAll('input[type="text"]').forEach(input => {
    input.addEventListener('blur', async (event) => {
        const field = event.target.id; // Use the input's ID as the field name
        const value = event.target.value;
        await updateClientData(field, value); // Wait for the client data to be updated
        loadClientData(); // Reload client data to ensure it is displayed in all caps
    });
});

// Add event listeners to dropdowns
document.querySelectorAll('select').forEach(select => {
    select.addEventListener('change', (event) => {
        const field = event.target.id; // Use the select's ID as the field name
        const value = event.target.value;
        updateClientData(field, value);
    });
});     

        function GoToProfileView() {
    const clientId = getQueryParam('id'); // Retrieve the client ID from the URL
    window.location.href = `profileview.html?id=${clientId}`; // Redirect to profileview.html with the client ID
}

        // Load client data on page load
        window.onload = loadClientData;

        async function confirmAndRedirect() {
    if (confirm("Are you sure you want to start screening?")) {
        const clientId = getQueryParam('id');
        const noteContent = "<strong>New screening initiated.</strong>";
        const timestamp = new Date().toLocaleString();
        const activeUser = sessionStorage.getItem('loggedInUser'); // Retrieve the active user

        if (!activeUser) {
            console.error("No active user found in sessionStorage.");
            return;
        }

        try {
            // Save client data
            await saveClient();

            // Add a note about the screening
            const note = {
                text: noteContent,
                timestamp: timestamp,
                username: activeUser
            };

            const response = await fetch('/add-note-to-client', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ clientId, note }),
            });

            const result = await response.json();
            if (!response.ok || !result.success) {
                console.error('Failed to add note to client:', result.message);
                alert('Failed to add note to client.');
                return;
            }

            console.log('Note successfully added to client.');

            // Update screening status in the database
            const updateResponse = await fetch('/update-client', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ clientId, clientData: { screeningInProgress: true } }),
            });

            const updateResult = await updateResponse.json();
            if (!updateResponse.ok || !updateResult.success) {
                console.error('Failed to update screening status:', updateResult.message);
                return;
            }

            console.log('Screening status successfully updated.');

            // Redirect to householdedit.html
            window.location.href = `householdedit.html?id=${clientId}`;
        } catch (error) {
            console.error("Error during confirmAndRedirect:", error);
        }
    }
}

async function releaseProfile() {
    const clientId = getQueryParam('id'); // Retrieve the client ID from the URL

    try {
        // Update screening status in the database
        const response = await fetch('/update-client', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ clientId, clientData: { screeningInProgress: false } }),
        });

        const result = await response.json();
        if (!response.ok || !result.success) {
            console.error('Failed to release profile:', result.message);
            return;
        }

        console.log('Profile successfully released.');

        // Optionally, show the "Start Screening" button if it exists on the page
        const startScreeningButton = document.getElementById('call-logging-button');
        if (startScreeningButton) {
            startScreeningButton.style.display = 'block';
        }
    } catch (error) {
        console.error('Error releasing profile:', error);
        alert('An error occurred while releasing the profile.');
    }
}

async function confirmAndTerminate() {
        const clientId = getQueryParam('id');
        const timestamp = new Date().toLocaleString();
        const activeUser = sessionStorage.getItem('loggedInUser');

        if (!activeUser) {
            console.error("No active user found in sessionStorage.");
            alert("Error: No active user found.");
            return;
        }

        // Check the current termination status
        const terminateButton = document.getElementById('terminate-button');
        const isTerminated = terminateButton.textContent === "Undo Profile Termination";

        const confirmationMessage = isTerminated
            ? "Are you sure you want to undo the termination of this profile?"
            : "Are you sure you want to terminate this profile?";

        if (confirm(confirmationMessage)) {
            try {
                await saveClient();

                const response = await fetch('/update-client', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ clientId, clientData: { terminated: !isTerminated } }),
                });

                const result = await response.json();
                if (!response.ok || !result.success) {
                    console.error('Failed to update termination status:', result.message);
                    alert('Failed to update termination status.');
                    return;
                }

                const note = {
                    text: isTerminated ? "Profile termination undone." : "Profile terminated.",
                    timestamp: timestamp,
                    username: activeUser,
                };

                const noteResponse = await fetch('/add-note-to-client', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ clientId, note }),
                });

                const noteResult = await noteResponse.json();
                if (!noteResponse.ok || !noteResult.success) {
                    console.error('Failed to add termination note:', noteResult.message);
                    alert('Failed to add termination note.');
                    return;
                }

                alert(isTerminated ? "The profile termination has been undone." : "The profile has been successfully terminated.");
                document.getElementById('terminationStatus').style.display = isTerminated ? 'none' : 'block';
                terminateButton.textContent = isTerminated ? "Terminate Profile" : "Undo Profile Termination";
            // Reload the page after the operation
            location.reload();
        } catch (error) {
            console.error("Error updating the profile termination status:", error);
            alert("An error occurred while updating the profile termination status. Please try again.");
        }
    }
}

    // Update the button text on page load based on the termination status
    async function updateTerminateButton() {
    const clientId = getQueryParam('id');
    try {
        const response = await fetch(`/get-client/${clientId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        });

        if (!response.ok) {
            throw new Error(`Failed to fetch client: ${response.statusText}`);
        }

        const client = await response.json();
        const terminateButton = document.getElementById('terminate-button');
        const terminationStatus = document.getElementById('terminationStatus');

        console.log('Client termination status:', client.terminated); // Debugging log

        if (client.terminated) {
            terminateButton.textContent = "Undo Profile Termination";
            terminationStatus.style.display = 'block'; // Show "PROFILE TERMINATED" message
            terminateButton.style.display = 'inline-block'; // Ensure the button is visible
        } else {
            terminateButton.textContent = "Terminate Profile";
            terminationStatus.style.display = 'none'; // Hide "PROFILE TERMINATED" message
            terminateButton.style.display = 'inline-block'; // Ensure the button is visible
        }
    } catch (error) {
        console.error('Error updating terminate button:', error);
    }
}

async function toggleSidebarVisibility() {
    const clientId = getQueryParam('id');
    try {
        const response = await fetch(`/get-client/${clientId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        });

        if (!response.ok) {
            throw new Error(`Failed to fetch client: ${response.statusText}`);
        }

        const client = await response.json();
        if (client && client.screeningInProgress) {
            document.getElementById('leftSidebarContainer').style.display = 'block';
        } else {
            document.getElementById('leftSidebarContainer').style.display = 'none';
        }
    } catch (error) {
        console.error('Error toggling sidebar visibility:', error);
    }
}

// Call the function after the page loads
window.onload = function () {
    loadClientData();
    updateTerminateButton();

};
    </script>
        <script src="estimations.js"></script>
<script src="notes.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
    let zipToCountyMap = {};

    // Load and parse the CSV file
    function loadZipCountyData() {
    Papa.parse('./uszips.csv', {
        download: true,
        header: true,
        complete: function (results) {
            results.data.forEach(row => {
                const zip = row.zip;
                const counties = row.county_names_all; // Use the county_names_all column
                if (zip && counties) {
                    if (!zipToCountyMap[zip]) {
                        zipToCountyMap[zip] = [];
                    }
                    // Split counties by "|" and add them to the map
                    counties.split('|').forEach(county => {
                        if (!zipToCountyMap[zip].includes(county.trim())) {
                            zipToCountyMap[zip].push(county.trim());
                        }
                    });
                }
            });
            console.log('Zip-to-county data loaded:', zipToCountyMap);

            // Filter the county dropdown on page load
            filterCountyDropdownOnPageLoad();
        },
        error: function (error) {
            console.error('Error loading CSV file:', error);
        }
    });
}

// Filter the county dropdown based on the zip code on page load
// Filter the county dropdown based on the zip code on page load
function filterCountyDropdownOnPageLoad() {
    const zipCodeInput = document.getElementById("zipCode");
    const countyDropdown = document.getElementById("county");
    const zipCode = zipCodeInput.value.trim();

    if (zipCode.length === 5 && zipToCountyMap[zipCode]) {
        // Populate the county dropdown based on the zip code
        const backendCounty = countyDropdown.value; // Preserve the preexisting county value
        updateCountyDropdown(zipToCountyMap[zipCode], backendCounty);
    } else {
        // If the zip code is invalid or blank, do not overwrite the dropdown
        console.log("Invalid or empty zip code on page load. Preserving existing county selection.");
    }
}

// Update the county dropdown based on the zip code
function updateCountyDropdown(counties, backendCounty = null) {
    const countyDropdown = document.getElementById("county");

    // Clear existing options
    countyDropdown.innerHTML = '<option value="" disabled>Select County</option>';

    counties.forEach(county => {
        const option = document.createElement("option");
        option.value = county;
        option.textContent = county;
        countyDropdown.appendChild(option);
    });

    // Auto-select logic
    if (backendCounty && counties.includes(backendCounty)) {
        // If a backend county exists and matches one of the counties, select it
        countyDropdown.value = backendCounty;
    } else if (counties.length === 1) {
        // If there's only one county, auto-select it
        countyDropdown.value = counties[0];
    } else {
        // Otherwise, leave the dropdown unselected
        countyDropdown.value = "";
    }
}

// Add event listener for the county dropdown
document.getElementById("county").addEventListener("change", function () {
    const selectedValue = this.value;

    if (selectedValue === "") {
        // If "Select County" is selected, set county to null in the database
        updateClientData('county', null);
    }
});

// Add event listener for zip code input
function setupZipCodeListener() {
    const zipCodeInput = document.getElementById("zipCode");
    const countyDropdown = document.getElementById("county");

    zipCodeInput.addEventListener("blur", async function () {
        const zipCode = this.value.trim();

        if (zipCode.length === 5 && zipToCountyMap[zipCode]) {
            // Populate the county dropdown based on the zip code
            updateCountyDropdown(zipToCountyMap[zipCode]);
        } else {
            // Reset the dropdown to "Select County" if the zip code is invalid, null, or blank
            countyDropdown.innerHTML = '<option value="" disabled selected>Select County</option>';
            console.log("Invalid, null, or empty zip code entered. Defaulting to 'Select County'.");

            // Set the county data to null in the backend
            await updateClientData('county', null);
        }
    });
}

async function setCheckedOutStatus(clientId, status) {
    try {
        const response = await fetch('/update-client', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                clientId, 
                clientData: { 
                    checkedOut: [
                        {
                            status: status, // Set status to false
                            timestamp: status ? new Date().toISOString() : null, // Clear timestamp if status is false
                            user: status ? sessionStorage.getItem('loggedInUser')?.trim() || 'Unknown User' : null // Clear user if status is false
                        }
                    ] 
                } 
            }),
        });

        const result = await response.json();
        if (!response.ok || !result.success) {
            console.error(`Failed to update checkedOut status to ${status}:`, result.message);
        } else {
            console.log(`Successfully updated checkedOut status to ${status}.`);
        }
    } catch (error) {
        console.error(`Error updating checkedOut status to ${status}:`, error);
    }
}

    // Ensure all initialization functions are executed
    document.addEventListener('DOMContentLoaded', function () {
        loadZipCountyData(); // Load the CSV data
        setupZipCodeListener(); // Set up the zip code input listener
        loadClientData(); // Load client data
        updateTerminateButton(); // Update the terminate button
    });
</script>
</body>
</html>