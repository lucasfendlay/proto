<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="userInfo.js"></script>

    <style>
        td[onclick] {
            color: blue;
            cursor: pointer;
            text-decoration: underline;
        }
    </style>


    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <h1>Admin Dashboard</h1>

    <div class="container">

        <button onclick="window.location.href='home.html'">Home</button>
        <button onclick="window.location.href='directory.html'">Directory</button>
        </div>

    <!-- Filters Section -->
    <div id="filters">
        <label for="userSelect">Select User:</label>
        <select id="userSelect">
            <option value="">All Users</option>
            <!-- Dynamically populate user options -->
        </select>

        <label for="startDate">Start Date:</label>
        <input type="text" id="startDate" placeholder="Select Start Date">

        <label for="endDate">End Date:</label>
        <input type="text" id="endDate" placeholder="Select End Date">

        <button id="generateReportButton">Generate Report</button>
    </div>

    <!-- Add the button and the section to display the checked-out clients -->
<div id="checkedOutClientsSection">
    <button id="viewCheckedOutClientsButton">View All Checked-Out Profiles</button>
    <div id="checkedOutClientsList" style="display: none;">
        <h2>Checked-Out Profiles</h2>
        <ul id="checkedOutClients"></ul>
    </div>
</div>

<script>
document.getElementById('viewCheckedOutClientsButton').addEventListener('click', async () => {
    try {
        // Fetch all clients
        const response = await fetch('/get-all-clients');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const { clients } = await response.json();

        // Filter clients with checkedOut status: true
        const checkedOutClients = clients.flatMap(client => 
            client.checkedOut?.filter(item => item.status === true).map(item => ({
                clientName: client.name,
                clientId: client.id,
                checkedOutBy: item.user
            })) || [] // If checkedOut is undefined, return an empty array
        );

        // Populate the list
        const checkedOutClientsList = document.getElementById('checkedOutClients');
        checkedOutClientsList.innerHTML = ''; // Clear existing list

        checkedOutClients.forEach(async (client) => {
    try {
        console.log('Fetching details for client ID:', client.clientId);

        // Use the /get-client/:clientId endpoint
        const response = await fetch(`/get-client/${client.clientId}`);
        if (!response.ok) {
            throw new Error(`Failed to fetch client details for ID: ${client.clientId}`);
        }
        const clientDetails = await response.json();

        // Populate the list item with fetched details
        const li = document.createElement('li');
        li.innerHTML = `
            <a href="profileview.html?id=${client.clientId}">
                <strong>Profile: ${client.clientId}</strong> | 
                Name: ${clientDetails.firstName?.toUpperCase() || 'N/A'} ${clientDetails.lastName?.toUpperCase() || 'N/A'} | 
                Phone: ${clientDetails.phoneNumber || 'N/A'} | 
                Checked out by: ${client.checkedOutBy || 'Unknown User'}
            </a>`;
        checkedOutClientsList.appendChild(li);
    } catch (error) {
        console.error(`Error fetching details for client ID ${client.clientId}:`, error);
    }
});

        // Show the list section
        document.getElementById('checkedOutClientsList').style.display = 'block';
    } catch (error) {
        console.error('Error fetching checked-out clients:', error);
    }
});
</script>

<!-- Report Section -->
<div id="report" style="display: none;">
    <h2>Report</h2>
    <table id="reportTable" border="1">
        <thead>
            <tr>
                <th>User</th>
                <th>Calls Logged</th>
                <th>Screenings Initated</th>
                <th>PACE Applications Completed</th>
                <th>PTRR Applications Completed</th>
                <th>LIS Applications Completed</th>
                <th>MSP Applications Completed</th>
                <th>SNAP Applications Completed</th>
                <th>LIHEAP Applications Completed</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dynamically populate report rows -->
        </tbody>
    </table>
</div>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        // Initialize Flatpickr for date inputs
        flatpickr("#startDate", {
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "F j, Y",
        });

        flatpickr("#endDate", {
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "F j, Y",
        });

        // Fetch users and populate the user dropdown
        async function populateUserDropdown() {
            try {
                const response = await fetch('/get-users');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const users = await response.json();
                const userSelect = document.getElementById('userSelect');
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = user.username;
                    userSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching users:', error);
            }
        }

        // Call the function to populate the dropdown on page load
        populateUserDropdown();

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('generateReportButton').addEventListener('click', generateReport);
        });

        async function generateReport() {
    const user = document.getElementById('userSelect').value;
    const startDate = new Date(document.getElementById('startDate').value);
    const endDate = new Date(document.getElementById('endDate').value);

    try {
        // Fetch all clients
        const response = await fetch('/get-all-clients');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const { clients } = await response.json();

        // Filter and process data
        const filteredClients = clients.filter(client => {
    const hasUser = !user || (client.callLogs && client.callLogs.some(log => log.agent === user));
    const hasDateRange = client.callLogs && client.callLogs.some(log => {
        const logDate = new Date(log.timestamp);
        return logDate >= startDate && logDate <= endDate;
    });
    return hasUser && hasDateRange;
});

// Generate report summary
const usersResponse = await fetch('/get-users');
if (!usersResponse.ok) {
    throw new Error(`HTTP error! status: ${usersResponse.status}`);
}
const users = await usersResponse.json();

const report = filteredClients.reduce((acc, client) => {
    const user = users.find(u => u.username === client.callLogs[0]?.agent)?.username || 'Unknown User';
    const callsLogged = client.callLogs.length;
    const screeningsStarted = client.notes.filter(note =>
        note.text.includes('New screening initiated.')
    ).length;

    // Count applications completed for each benefit type
    const paceApplicationsCompleted = client.notes.filter(note =>
        note.text.includes('PACE Application completed.')
    ).length;
    const ptrrApplicationsCompleted = client.notes.filter(note =>
        note.text.includes('PTRR Application completed.')
    ).length;
    const lisApplicationsCompleted = client.notes.filter(note =>
        note.text.includes('LIS Application completed.')
    ).length;
    const mspApplicationsCompleted = client.notes.filter(note =>
        note.text.includes('MSP Application completed.')
    ).length;
    const snapApplicationsCompleted = client.notes.filter(note =>
        note.text.includes('SNAP Application completed.')
    ).length;
    const liheapApplicationsCompleted = client.notes.filter(note =>
        note.text.includes('LIHEAP Application completed.')
    ).length;

    // Check if the user already exists in the accumulator
    const existingUser = acc.find(row => row.user === user);
    if (existingUser) {
        // Aggregate the fields
        existingUser.callsLogged += callsLogged;
        existingUser.screeningsStarted += screeningsStarted;
        existingUser.paceApplicationsCompleted += paceApplicationsCompleted;
        existingUser.ptrrApplicationsCompleted += ptrrApplicationsCompleted;
        existingUser.lisApplicationsCompleted += lisApplicationsCompleted;
        existingUser.mspApplicationsCompleted += mspApplicationsCompleted;
        existingUser.snapApplicationsCompleted += snapApplicationsCompleted;
        existingUser.liheapApplicationsCompleted += liheapApplicationsCompleted;
    } else {
        // Add a new user entry
        acc.push({
            user,
            callsLogged,
            screeningsStarted,
            paceApplicationsCompleted,
            ptrrApplicationsCompleted,
            lisApplicationsCompleted,
            mspApplicationsCompleted,
            snapApplicationsCompleted,
            liheapApplicationsCompleted
        });
    }

    return acc;
}, []);

// Render the report in the table
const tableBody = document.querySelector('#reportTable tbody');
tableBody.innerHTML = ''; // Clear existing rows

report.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${row.user}</td>
        <td onclick="redirectToUserProfiles('callsLogged', '${row.user}')">${row.callsLogged}</td>
        <td onclick="redirectToUserProfiles('screeningsStarted', '${row.user}')">${row.screeningsStarted}</td>
        <td onclick="redirectToUserProfiles('paceApplicationsCompleted', '${row.user}')">${row.paceApplicationsCompleted}</td>
        <td onclick="redirectToUserProfiles('ptrrApplicationsCompleted', '${row.user}')">${row.ptrrApplicationsCompleted}</td>
        <td onclick="redirectToUserProfiles('lisApplicationsCompleted', '${row.user}')">${row.lisApplicationsCompleted}</td>
        <td onclick="redirectToUserProfiles('mspApplicationsCompleted', '${row.user}')">${row.mspApplicationsCompleted}</td>
        <td onclick="redirectToUserProfiles('snapApplicationsCompleted', '${row.user}')">${row.snapApplicationsCompleted}</td>
        <td onclick="redirectToUserProfiles('liheapApplicationsCompleted', '${row.user}')">${row.liheapApplicationsCompleted}</td>
    `;
    tableBody.appendChild(tr);
});

// Make the report section visible
document.getElementById('report').style.display = 'block';

console.log('Generated Report:', report);
    } catch (error) {
        console.error('Error generating report:', error);
    }
}

function redirectToUserProfiles(metric, user) {
    const queryParams = new URLSearchParams();
    queryParams.append('metric', metric);
    if (user) {
        queryParams.append('username', user);
    }
    window.location.href = `userProfiles.html?${queryParams.toString()}`;
}

    </script>
</body>
</html>