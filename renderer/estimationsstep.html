<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimations Edit</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="notes.css">
    <link rel="stylesheet" href="householdedit.css">
    <script src="userInfo.js"></script>

    <style>

        #save-continue {
            display: none; /* Default to block, will be toggled by JS */
        }

#save-exit, #save-continue {
            border: 1px solid #000000;
            border-radius: 5px; /* Rounded corners */
            padding: 10px 20px; /* Add padding for better spacing */
            background-color: #007bff; /* Light background color */
            color: white; /* Blue text color */
            transition: background-color 0.3s, color 0.3s; /* Smooth hover effect */
        }
    
        /* Hover effect for the buttons */
        #save-exit:hover, #save-continue:hover {
            background-color: #0056b3; /* Blue background on hover */
            color: white; /* White text on hover */
        }

        details > summary {
    cursor: pointer; /* Change cursor to hand */
}
        /* General styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            margin-top: 60px; /* Adjust this value to match the height of the navigation container */
        }
        
        #app {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Header styles */
        h1 {
            text-align: center;
            color: #444;
        }
        
        /* Household member container */
        #household-members-container {
            display: absolute;
            flex-direction: column;
            align-items: center; /* Center the content horizontally */
            gap: 15px; /* Add gap between SNAP household boxes */
            min-width: 500px; /* Ensure minimum width for better visibility */
            max-width: 500px; /* Limit maximum width for layout consistency */
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        /* Individual household member card */
        .household-member-box {
    border: none;
    align-self: center; /* Center the box horizontally */
    padding: 15px;
    margin-bottom: 10px; /* Reduce the gap between cards */
    border-radius: 5px;
    background: #f4f4f4; /* Slightly darker gray than the page background */
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.household-member-box:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}       
        /* Member details */
        .household-member-box h3 {
            margin: 0 0 10px;
            font-size: 1.2em;
            color: #333;
        }
        
        .household-member-box p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #555;
        }
        
        /* Spouse details */
        .household-member-box p span {
            font-weight: bold;
            color: #444;
        }
        
        /* SNAP household container */
        #snap-household-container {
    display: flex;
    flex-direction: column;
    align-items: center; /* Center the content horizontally */
    min-width: 500px; /* Ensure minimum width for better visibility */
    max-width: 500px; /* Limit maximum width for layout consistency */
    padding: 20px;
    background: #f9f9f9;
    border-radius: 8px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    margin-top: 20px; /* Add consistent spacing above the SNAP container */
}
 
#liheap-household-container {
    display: flex;
    flex-direction: column;
    align-items: center; /* Center the content horizontally */
    min-width: 500px; /* Ensure minimum width for better visibility */
    max-width: 500px; /* Limit maximum width for layout consistency */
    padding: 20px;
    background: #f9f9f9;
    border-radius: 8px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    margin-top: 20px; /* Add consistent spacing above the SNAP container */
}
        /* SNAP household box */
        
        .snap-household-box h3 {
            margin-top: 0;
            color: #333;
        }
        </style>
</head>
<body>
    <h1>Estimated Eligibilities</h1>
    <div id="notes-container">
        <textarea id="note-input" placeholder="Add Note..."></textarea>
        <button id="save-note">Save Note</button>
        <div id="notes-list">
            </div>
            </div>

            <div id="snap-household-container"></div>
            <div id="liheap-household-container"></div>

    <div id="household-members-container" class="household-member-container"></div>

        <!-- Add Save and Release Profile button -->
        <div class="button-container">
            <button id="save-continue" onclick="continueToApplication()">Continue to Applicant Step</button>
        </div>
        <div class="button-container">
            <button id="save-exit" onclick="redirectToEstimationsView()">Save and Release Profile</button>
        </div>
    
</body>


<script>

function getQueryParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

async function redirectToEstimationsView() {
    // Retrieve the client ID from the query parameters
    const clientId = getQueryParameter('id');
    if (!clientId) {
        console.error('Client ID not found in query parameters.');
        return;
    }

    const confirmAction = confirm("Are you sure you want to save and release this profile?");
    if (!confirmAction) {
        return;
    }

    const noteContent = "Profile released.";
    const timestamp = new Date().toLocaleString();
    const activeUser = sessionStorage.getItem('loggedInUser'); // Retrieve the active user

    if (!activeUser) {
        console.error("No active user found in sessionStorage.");
        return;
    }

    try {
        // Perform any necessary save operations here
        console.log("Saving profile and redirecting...");

        // Add a note about the action
        const note = {
            text: noteContent,
            timestamp: timestamp,
            username: activeUser
        };

        const addNoteResponse = await fetch(`/add-note-to-client`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ clientId, note })
        });

        if (!addNoteResponse.ok) {
            console.warn('Failed to add note to client.');
        }

        // Update screening status in the database
        const updateClientResponse = await fetch(`/update-client`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                clientId,
                clientData: { screeningInProgress: false }
            })
        });

        if (!updateClientResponse.ok) {
            console.warn('Failed to update client.');
        }
    } catch (error) {
        console.error("Error during redirectToEstimationsView:", error);
    } finally {
        // Redirect to the estimations view page regardless of success or failure
        window.location.href = `estimationsview.html?id=${clientId}`;
    }
}

async function continueToApplication() {
    // Retrieve the client ID from the query parameters
    const clientId = getQueryParameter('id');
    if (!clientId) {
        console.error('Client ID not found in query parameters.');
        return;
    }

    const activeUser = sessionStorage.getItem('loggedInUser'); // Retrieve the active user
    if (!activeUser) {
        console.error("No active user found in sessionStorage.");
        return;
    }

    // Confirm the action with the user
    const confirmAction = confirm("Are you sure you want to continue to the application step?");
    if (!confirmAction) {
        return;
    }

    try {
        // Fetch household members from the backend
        const response = await fetch(`/get-client/${clientId}`);
        if (!response.ok) {
            throw new Error(`Failed to fetch client data: ${response.statusText}`);
        }

        const clientData = await response.json();
        const members = clientData.householdMembers || [];

        // Separate household-wide benefits and individual benefits
        const householdBenefits = new Set(); // Set to track SNAP and LIHEAP (household-wide benefits)
        const individualBenefitsDetails = []; // Array to store individual benefit details

        members.forEach(member => {
            const memberBenefits = []; // Track benefits for this specific member

            ['PACE', 'LIS', 'MSP', 'PTRR', 'SNAP', 'LIHEAP'].forEach(benefit => {
                if (member[benefit]?.application?.some(app => app.applying === true)) {
                    if (['SNAP', 'LIHEAP'].includes(benefit)) {
                        // Add SNAP and LIHEAP to the household-wide benefits set
                        householdBenefits.add(benefit);
                    } else {
                        // Add individual benefits to the member's list
                        memberBenefits.push(benefit);
                    }
                }
            });

            // If the member has individual benefits, add their name and benefits to the details
if (memberBenefits.length > 0) {
    individualBenefitsDetails.push(
        `<strong>${member.firstName.toUpperCase()} ${member.lastName.toUpperCase()}</strong><br>${memberBenefits.join('<br>')}`
    );
            }
        });

        // Generate the note content
const householdBenefitsText = Array.from(householdBenefits).join('<br>'); // Use <br> for line breaks
const individualBenefitsText = individualBenefitsDetails.join('<br><br>'); // Separate members with double <br>

let noteContent = '';
if (householdBenefits.size > 0) {
    // If household benefits exist, include them with a line break before individual benefits
    noteContent = `<strong>Applying</strong><br><br>${householdBenefitsText}<br><br>${individualBenefitsText}`.trim();
} else {
    // If no household benefits, exclude the extra line break before individual benefits
    noteContent = `<strong>Applying</strong><br><br>${individualBenefitsText}`.trim();
}

const timestamp = new Date().toLocaleString();

// Add a note about the action
const note = {
    text: noteContent,
    timestamp: timestamp,
    username: activeUser
};

// Send the note to the backend
const addNoteResponse = await fetch(`/add-note-to-client`, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({ clientId, note })
});

if (!addNoteResponse.ok) {
    console.warn('Failed to add note to client.');
}

console.log("Note added:", noteContent);

    } catch (error) {
        console.error("Error during continueToApplication:", error);
    } finally {
        // Redirect to the application edit page regardless of success or failure
        window.location.href = `applicationedit.html?id=${clientId}`;
    }
}
</script>
</html>
    <script src="estimationsstep.js" defer></script>
    <script src="notes.js"></script>
    <script src="editnavigation.js"></script>
